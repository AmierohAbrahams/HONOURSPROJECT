---
title: "Final_Honours_Methods"
author: "Amieroh Abrahams"
date: "16 November 2018"
output: html_document
---

## Methods

### Startup

First I need to find, install and load various packages. These packages will be available on CRAN and can be accessed and installed in the usual way. Here i also load the various functions that are found in the folder labeled functions.

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(ggpubr)
library(zoo)
library(lubridate)
library(ggrepel)
library(FNN)
library(stringr)
library(circular)
library(broom)
library(ggrepel)
library(purrr)
library(stlplus)
source("functions/earthdist.R")
source("functions/scale.bar.func.R")
source("function/wind.rose.R")
source("function/waverose.diagram.R")
```

### Load SACTN data

Now to get to the data. The first step involves the loading of the site list. The statistical properties of the seawater temperature representing the South African coastline, such as the mean, minimum and maximum temperatures. These values vary among coastal sections due to the influence of the cold Benguala and warm Agulhas currents.

```{r load_files1, include=TRUE}
load("data/site_list_v4.2.RData")
```

### Clustering

Performing the k-means clustering on a data matrix using the `kmeans()` function, which uses multiple random seeds to find a number of clusting solutions; it selects as the final solution the one that has the minimum total within-cluster sum of squared distances. The data contain variables from many sites along the South African coastline, but in the analysis I use only some of them. These variables include the mean, min and max temperature values. This allows me to group sites based on similar temperature variations. 

```{r setup_k-means, include=TRUE}
set.seed(10)
kmeans(site_list[,c(15, 18, 19)], 6)$cluster
clust_columns <- site_list[,c(15, 18:19)]
```

The coastal region is divided into three sections, namely the cold west coast, warm east coast and the subtropical south coast (Schlegel and Smit 2016; Smit et al 2013; Mead et al 2013). The Benguela Marine Province (BMP) is located to the west of Cape Point and is characterized by the movement of cold water from the Southern Ocean moving north. The cold temperate west coast mentioned above is greatly affected by the upwelling caused by offshore winds, generated by the cold Benguela current. Thus the seawater temperatures found around South Africa’s coastline exhibits a large variational range. My plotting functions partition the data into the clusters and colour code each point accordingly so that I am able to see patterns that exist and distictly group the different sites with similar temperatures along the three distinct coasts. The k-means function previously mentioned produced six clusters. Cluster six was selected as this represented the most accurate and distinct site groupings based on this temperature distribution. Showing a distinct east, south and west coast based on the mean, min and max temperature values.

```{r define_fun1, include=TRUE}
clust_i <- function(i) {
  set.seed(10)
  ggplot(data = site_list,
         aes(x = lon, y = lat,
             colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    borders() +
    geom_point() +
    labs(colour = "cluster") +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
    ggtitle(paste0("clust = ", i))
}

```

```{r run_fun1, include=TRUE}
clust_8 <- clust_i(8)
clust_7 <- clust_i(7)
clust_6 <- clust_i(6)
clust_5 <- clust_i(5)
clust_4 <- clust_i(4)
clust_3 <- clust_i(3)

clusters <- ggarrange(clust_8, clust_7, clust_6, clust_5, clust_4, clust_3, common.legend = T)
clusters
```

Here i load in the data which allows me to create a map of the study area 

```{r}
load("data/southern_africa_coast.Rdata")
load("data/africa_coast.RData")
load("data/sa_provinces_new.RData")
load("data/sa_coast.Rdata")
```

Mapping the sixth cluster - To be added into the methods section

```{r load_files3, include=TRUE}
load("Mapping/sa_provinces.RData")
load("Mapping/south_africa_coast.RData")
load("data/southern_africa_coast.Rdata")
load("data/africa_coast.RData")
load("data/sa_provinces_new.RData")
load("data/sa_coast.Rdata")
```

```{r}
library(tidyverse)
library(viridis)
library(gridExtra)
library(dplyr)

clust_i <- function(i) {
  set.seed(10)
  ggplot(data = south_africa_coast, aes(x = lon, y = lat)) +
    geom_polygon(aes(group = group), fill = "white") +
    borders() +
    geom_point(data = site_list,
               aes(x = lon, y = lat,
                   colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    labs(colour = "cluster")  +
    annotate("text", label = "INDIAN\nOCEAN", x = 34.00, y = -35.0,
             size = 6.0, angle = 0, colour = "black") +
    annotate("text", label = "ATLANTIC\nOCEAN", x = 14.00, y = -37.0,
             size = 6.0, angle = 0, colour = "black") +
    geom_segment(aes(x = 17.2, y = -32.6, xend = 15.2, yend = -29.5),
                 arrow = arrow(length = unit(0.3, "cm")),
                 size = 0.1, colour = "black") +
    annotate("text", label = "Benguela", x = 16.0, y = -31.8,
             size = 6.5, angle = 302, colour = "black") +
    geom_segment(aes(x = 33, y = -29.5, xend = 29.8, yend = -33.0),
                arrow = arrow(length = unit(0.3, "cm")),
                size = 0.1, colour = "black") +
    annotate("text", label = "Agulhas", x = 31.7, y = -31.7,
             size = 6.5, angle = 50, colour = "black") +
    # Improve on the x and y axis labels
    coord_fixed(ratio = 1, xlim = c(10.5, 39.5), ylim = c(-39.5, -25.5),
                expand = TRUE) +
    scale_x_continuous(expand = c(0, 0),
                       labels = scales::unit_format(unit = "°E", sep = "")) +
    scale_y_continuous(expand = c(0, 0),
                       labels = scales::unit_format(unit = "°S", sep = "")) +
    labs(x = NULL, y = NULL) +
    scaleBar(lon = 32.0, lat = -38.7, distanceLon = 200, distanceLat = 50, 
             distanceLegend = 90, dist.unit = "km", arrow.length = 100,
             arrow.distance = 130, arrow.North.size = 3) +
    theme_bw() +
    theme(panel.border = element_rect(fill = NA, colour = "black", size = 1),
          axis.text = element_text(colour = "black", size = 18),
          axis.title = element_text(colour = "black", size = 18),
          axis.ticks = element_line(colour = "black"))
}

clust_6 <- clust_i(8)
clust_6

africa_map <- ggplot(africa_coast, aes(x = lon, y = lat)) + 
  theme_bw() + 
  coord_equal() + 
  geom_polygon(aes(group = group), colour = "black", fill = "grey80") + 
  geom_polygon(data = sa_provinces_new, (aes(group = group))) +
  annotate("text", label = "Africa", x = 16.0, y = 15.0, size = 3) + 
  theme(panel.border = element_rect(colour = "black", size = 0.4), 
        plot.background = element_blank(), 
        axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  coord_map(xlim = c(-20, 53), ylim = c(-36, 38), projection = "mercator") 
africa_map

pdf("figures/map_fixed.pdf", width = 8, height = 5, pointsize = 6) # Set PDF dimensions
vp1 <- viewport(x = 0.70, y = 0.58, w = 0.25, h = 0.25, just = c("left", "bottom")) # Africa
vp2 <- viewport(x = 1.0, y = 1.0, w = 1.00, h = 1.00, just = c("right", "top"))  # South Africa
print(clust_6, vp = vp2)
print(africa_map, vp = vp1)
dev.off()
```

It is now necessary to load the daily SACTN temperature dataset. The SACTN dataset comprise of 129 *in situ* coastal seawater temperatures derived from daily measurements over up to 40 years. The SACTN temperature dataset was compiled by measuring coastal temperatures at 129 sites along the coast of South Africa, daily from 1972 until 2017. 

```{r load_files2, include=TRUE}
load("SACTN_data/SACTN_daily_v4.2.RData")
```

Clustering the sites using the k-means results: Creating a cluster index whilst only selecting cluster 6 Working with at least one decade of data for each of the sites along the coast, and excluding time series with temperature data collected deeper than a five metres. This was done to ensure that the wave data accurately matches up with the temperature data. Some of the UTR's used to collected the temperature data were placed at a depth of 18m. The wave data however is recorded at 7m and 15m respectivley. The length, decadal trend and precision of each time series were adjusted in a systematic manner. This forms the core of the analysis. The natural variability occuring between sites of each of the time series, which differs predictabily between the coastlines is affected by the Benguela and Agulhas currents.
  
```{r run_k-means, include=TRUE}
set.seed(10)
site_list$cluster <- as.factor(kmeans(site_list[,c(15, 18:19)], 6)$cluster)

site_list_clusters <- site_list %>% 
  filter(length >= 3650, depth <= 5)

SACTN_daily_clusters <- SACTN_daily_v4.2 %>% 
  left_join(site_list[,c(4, 13, 21)], by = "index") %>% 
  filter(index %in% site_list_clusters$index)
```

### Site selection

With the sites now split into six clusters, the next step is to reduce the number of sites per cluster down to a manageable, but still representative, sub-sample of the whole. This is done primarily for two reasons. The first, simply, is to allow for the comparisons to be more readily interpretable by humans. The second more objective reason is to allow for an equal amount of sampling per cluster. The East coast is much more heavily sampled than the rest and so this imbalance must be addressed. The criteria that must be considered for the sub-samples are that both instrument types (UTR and thermometer) are present, and as many sources are included as are possible. The statistical characteristics of the seawater temperature dataset was used as to guide analyses into the suitability of the time series which allows us to produce an accurate assessment of temperature variation between sites located within the same cluster. The precision, length and decadal trend of the time series for each of the sites were adjusted systematically.

```{r site_sub_samples, include=TRUE}
# First simply divide up the site list by cluster
sites_1 <- site_list_clusters %>%
  filter(cluster == 1)
sites_2 <- site_list_clusters %>%
  filter(cluster == 2)
sites_3 <- site_list_clusters %>%
  filter(cluster == 3)
sites_4 <- site_list_clusters %>%
  filter(cluster == 4)
sites_5 <- site_list_clusters %>%
  filter(cluster == 5)
sites_6 <- site_list_clusters %>%
  filter(cluster == 6)

# I then grouped the sub-samples by source and took the longest time series
# When fewer than 4 sources were present, I took the next longest time series etc.
sites_1_sub <- sites_1 %>%
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  ungroup()

sites_2_sub <- sites_2 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,3))

sites_3_sub <- sites_3 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,5))

sites_4_sub <- sites_4 %>% 
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  ungroup() %>% 
  slice(c(2,3,4))

sites_5_sub <- sites_5 %>% 
  group_by(src) %>%
  ungroup() %>% 
  slice(c(1,4,10)) # slicing the 10row of site5.....

sites_6_sub <- sites_6 %>% 
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,3))

site_list_sub <- rbind(sites_1_sub, sites_2_sub, sites_3_sub, sites_4_sub, sites_5_sub, sites_6_sub)
SACTN_daily_clusters_sub <- SACTN_daily_clusters %>%
  filter(index %in% site_list_sub$index)
```

### Site locations

Map showing the location of each site within each of the six clusters

```{r define_fun2, include=TRUE}
site_coordinates1 <- filter(site_list_sub, cluster == 1) %>% 
  select(site, lon, lat)

site_coordinates2 <- filter(site_list_sub, cluster == 2) %>% 
  select(site, lon, lat)

site_coordinates3 <- filter(site_list_sub, cluster == 3) %>% 
   select(site, lon, lat)

site_coordinates4 <- filter(site_list_sub, cluster == 4) %>% 
  select(site, lon, lat)

site_coordinates5 <- filter(site_list_sub, cluster == 5) %>% 
  select(site, lon, lat)

site_coordinates6 <- filter(site_list_sub, cluster == 6) %>% 
  select(site, lon, lat)

mapping_plot <- function(df, xy = "salmon"){
  mapping <- df %>% 
    ggplot(aes(x = lon, y = lat)) +
    geom_polygon(data = south_africa_coast, aes(group = group), fill = "white") +
    coord_cartesian(xlim = c(12, 36), ylim = c(-32, -20)) +
    geom_path(data = sa_provinces, aes(group = group)) +
    geom_point(data = df, colour = xy, size = 4)  +
    geom_label_repel(data =df, aes(x = lon, y = lat, label = site), 
                     size = 6, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, 
                     segment.alpha = 0.4, force = 0.1) +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
    annotate("text", label = "INDIAN\nOCEAN", x = 35.00, y = -34.0, size = 6.0, angle = 0, colour = "black") +
    annotate("text", label = "ATLANTIC\nOCEAN", x = 16.00, y = -37.0, size = 6.0, angle = 0, colour = "black") +
    annotate("text", label = "Agulhas", x = 31.7, y = -31.7, size = 7.5, angle = 53, colour = "black") +
    scale_x_continuous(labels = scales::unit_format(unit = "°E", sep = "")) +
    scale_y_continuous(labels = scales::unit_format(unit = "°S", sep = "")) +
    labs(x = NULL, y = NULL) +
    coord_cartesian(xlim = c(10.5, 39.5), ylim = c(-39.5, -25.5), expand = F) +
    scaleBar(lon = 32.0, lat = -38.7, distanceLon = 200, distanceLat = 50, 
             distanceLegend = 90, dist.unit = "km", arrow.length = 100,
             arrow.distance = 130, arrow.North.size = 3) +  
    coord_equal() +
    theme(aspect.ratio = 1)  +
    theme_bw() +
    theme(panel.border = element_rect(fill = NA, colour = "black", size = 1),
          axis.text = element_text(colour = "black", size = 22),
          axis.title = element_text(colour = "black", size = 22))
  return(mapping)
}
```

```{r run_fun2, fig.cap = "Maps showing closely related sites based on temperature variation at different regions along the coastline.", fig.height = 9, fig.width = 8}
map_clus1 <- mapping_plot(df = site_coordinates1, xy = "salmon")
map_clus2 <- mapping_plot(df = site_coordinates2, xy = "darkgoldenrod4")
map_clus3 <- mapping_plot(df = site_coordinates3, xy = "springgreen4")
map_clus4 <- mapping_plot(df = site_coordinates4, xy= "lightskyblue")
map_clus5 <- mapping_plot(df = site_coordinates5, xy= "steelblue3") 
map_clus6 <- mapping_plot(df = site_coordinates6, xy= "mediumorchid1") 

final_map_combined_A <- ggarrange(map_clus1, map_clus2, map_clus3, map_clus4, map_clus5, map_clus6, ncol = 2, nrow = 3)
final_map_combined_A
# Saving the figure created above
# ggsave(plot = final_map_combined_A, filename = "figures/final_combined_plot.pdf")
```

## Calculating the distance between sites

Calculating the distance between each of the sites along the coastline. The deg2rad function transforms degrees to radians: Transforms between angles in degrees and radians. 

```{r calc-dists}
options(scipen=999) # Forces R to not use exponential notation
sa_coast_prep <- sa_coast %>% 
  mutate(site = 1:nrow(.),
         X = deg2rad(X),
         Y = deg2rad(Y)) %>% 
  select(site, X, Y)

sa_coast_dist <- as.data.frame(round(PairsDists(sa_coast_prep), 2)) %>% 
  mutate(lon = sa_coast$X,
         lat = sa_coast$Y) %>% 
  dplyr::rename(dist = V1) %>%
  select(lon, lat, dist) %>% 
  mutate(cum_dist = cumsum(dist)) %>% 
  mutate(dist = lag(dist),
         cum_dist = lag(cum_dist))
```

### Matching sites

Creating a function to match the sites with in a cluster: This function allows me to match sites within the same cluster based on the date that temperature was collected. This allows me to compare whether or not a temperature variation exist between sites within the same cluster and to examine various reasons for this variation. Here we consider distance between sites.

```{r define_fun3, include=TRUE}
clust_match <- function(df, clust) {
  SACTN_clust_x_match <- data.frame()
  df2 <- df %>%
    filter(cluster == clust) %>%
    select(-length) %>%
    droplevels()
  for (i in 1:length(levels(df2$index))) {  
    SACTN_df_1 <- filter(df2, index == levels(index)[i])
    
    # Find the cumulative distance of site 1 along the coast
    site_dist_1 <- site_list_clusters %>% 
      filter(index == as.character(SACTN_df_1$index)[1])
    site_dist_1 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                              query = as.matrix(site_dist_1[,5:6]), k = 1)
    site_dist_1 <- sa_coast_dist$cum_dist[site_dist_1]
    
    for (j in 1:length(levels(df2$index))) {
      if (i == j) {
        next
      }
      if (j < i) {
        next
      }
      SACTN_df_2 <- filter(df2, index == levels(index)[j])
      
      # Find the cumulative distance of site 2 along the coast
      site_dist_2 <- site_list_clusters %>% 
        filter(index == as.character(SACTN_df_2$index)[1])
      site_dist_2 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                                query = as.matrix(site_dist_2[,5:6]), k = 1)
      site_dist_2 <- sa_coast_dist$cum_dist[site_dist_2]
      
      # # The distance between the two sites
      site_dist_3 <- round(abs(site_dist_1-site_dist_2), 0)

      SACTN_df_3 <- left_join(SACTN_df_1, SACTN_df_2, by = "date") %>%
        na.trim() %>%
        select(date, index.x, temp.x, index.y, temp.y, -cluster.x, -cluster.y) %>%
        dplyr::rename(index_1 = index.x,
          temp_1 = temp.x,
          index_2 = index.y,
          temp_2 = temp.y) %>%
        mutate(index_pair = paste0(index_1, " - ", index_2, " - ", site_dist_3),
               index_dist = site_dist_3)
      SACTN_clust_x_match <- rbind(SACTN_clust_x_match, SACTN_df_3)
    }
  }
  return(SACTN_clust_x_match)
}
```

Creating a function which allows me to calculated the monthly mean temperature and standard deviation for each year and sites. Consequently we have a data frame with 7 columns and each of the rows representing each month for each of the years. By calculating the mean and SD for each site i am able identify trends in their temperatures and to compare these trends across sites within the same cluster. Mean and SD gives a broad look of the overall temperature for each of the sites. With each group of months representing the season.

```{r run_fun3, include=TRUE}
# Calculate all of the matche-ups in cluster 1
SACTN_clust_1_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 1)
SACTN_clust_2_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 2)
SACTN_clust_3_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 3)
SACTN_clust_4_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 4)
SACTN_clust_5_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 5)
SACTN_clust_6_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 6)

clust_matched <- function(df) {
  SACTN_clust_x_matched <- df %>%
  mutate(temp_matched = temp_1-temp_2,
         month = month(date, abbr = T, label = T),
         year = year(date)) %>%
  select(-temp_1, -temp_2) %>%
  group_by(index_pair, index_dist, month, year) %>%
  summarise(temp_mean_month_year = mean(temp_matched, na.rm = T),
            temp_sd_month_year = sd(temp_matched, na.rm = T)) %>% 
    mutate(season = ifelse(month %in% c("Jan", "Feb", "Mar"), "Summer",        
                           ifelse(month %in% c("Apr", "May", "Jun"), "Autumn",
                                ifelse(month %in% c("Jul", "Aug", "Sep"), "Winter",
                                       ifelse(month %in% c("Oct", "Nov", "Dec"), "Spring","Error")))))
  return(SACTN_clust_x_matched)
}

SACTN_clust_1_matched <- clust_matched(df = SACTN_clust_1_match)
SACTN_clust_2_matched <- clust_matched(df = SACTN_clust_2_match)
SACTN_clust_3_matched <- clust_matched(df = SACTN_clust_3_match)
SACTN_clust_4_matched <- clust_matched(df = SACTN_clust_4_match)
SACTN_clust_5_matched <- clust_matched(df = SACTN_clust_5_match)
SACTN_clust_6_matched <- clust_matched(df = SACTN_clust_6_match)
```

#### ANOVA

Anova analysis: This allows me to compare one variable in two or more groups taking into account the variability of other variables. This analysis of covariance is used to test the main effect of variables on a continuous variable. In this case we specifically analyse the relationship between index pair, year and season as a function of the mean temperature per year for each of the months. The results shows a significant difference between each pair of sites within each of the cluster.

```{r define_fun6, include=TRUE}
anova_func <- function(df){
  sites_aov <- aov(temp_mean_month_year ~ index_pair * year * season, data = df)
return(sites_aov)
}
```

```{r run_fun6, include=TRUE}
anova_clus_1_func1 <- anova_func(df = SACTN_clust_1_matched)
summary(anova_clus_1_func1)
anova_clus_2_func1 <- anova_func(df = SACTN_clust_2_matched)
summary(anova_clus_2_func1)
anova_clus_3_func1 <- anova_func(df = SACTN_clust_3_matched)
summary(anova_clus_3_func1)
anova_clus_4_func1 <- anova_func(df = SACTN_clust_4_matched)
summary(anova_clus_4_func1)
anova_clus_5_func1 <- anova_func(df = SACTN_clust_5_matched)
summary(anova_clus_5_func1)
anova_clus_6_func1 <- anova_func(df = SACTN_clust_6_matched)
summary(anova_clus_6_func1)
```

### Comparing sites

The code below lets us visualise the temperatures for each of the sites.  This box plot allows me to observe whether or not a variation exist between the sites found within the same cluster. The values represent the distance "km" between the sites Temperature 1 represents a site and temperature 2 represents a second site. The boxplot shows the temperature variation of two sites within the same cluster (along the same coast) being compared to eachother. To conclude, temperatures were not uniformly distributed with each set of sites having a unique temperature variation. 

```{r define_fun4, include=TRUE}
addline_format <- function(x,...){
  gsub('-', '\n', x)
}
clust_plot <- function(df) {
  plot1 <- df %>%
    select(-index_1, -index_2) %>% 
    mutate(index_pair = addline_format(index_pair)) %>% 
    gather(key = "temp_grp", val = "temp", -date, -index_pair, - index_dist) %>% 
    ggplot(aes(x = index_pair)) +
    geom_boxplot(aes(y = temp, fill = temp_grp), alpha = 0.3) +
    scale_fill_manual(values = c("khaki4", "chartreuse3")) +
    labs(x = "Paired Sites", y = "Temperature (°C)") +
    theme(legend.position="none") +
    theme_bw()+
    guides(fill = guide_legend(title = "Site\ntemperatures"))+
    coord_cartesian(ylim = c(0, 30)) +
    theme(axis.text = element_text(size = 18),
          axis.title = element_text(size = 18),
          legend.text = element_text(size = 14),
          legend.title = element_text(size = 16))
  return(plot1)
}
```

```{r run_fun4,  fig.cap = "Boxplots representing the different site locations along the South African coast represented by various temperature parameters. Temperature parameters include minimum, maximum and mean temperatures (°C). The Boxplots represent the minimum, 25th percentile, median and 75th percentile of the temperatures measured. The interquartile can be dedudced by the difference between the percentiles with the dots representing the outliers in the data.", fig.height = 8, fig.width= 10}
SACTN_clust_1_plot1 <- clust_plot(df = SACTN_clust_1_match)
SACTN_clust_2_plot1 <- clust_plot(df = SACTN_clust_2_match)
SACTN_clust_3_plot1 <- clust_plot(df = SACTN_clust_3_match)
SACTN_clust_4_plot1 <- clust_plot(df = SACTN_clust_4_match)
SACTN_clust_5_plot1 <- clust_plot(df = SACTN_clust_5_match)
SACTN_clust_6_plot1 <- clust_plot(df = SACTN_clust_6_match)

combined_plot <- ggarrange(SACTN_clust_1_plot1, SACTN_clust_2_plot1,
                           SACTN_clust_3_plot1, SACTN_clust_4_plot1, 
                           SACTN_clust_5_plot1, SACTN_clust_6_plot1, ncol = 2, nrow = 3)
combined_plot

# ggsave(plot = combined_plot, filename = "figures/combined_plot.pdf") #Saving the plot created above
```

### Comparing time series

Now I create a visualisation to reveal the relationship between the mean temperature for each month of each year over time for each of the sites in cluster: This allows me to assess whether or not an average temperature differences exist between sites on a seasonal basis and to examine the intensity of this variation over the past years. It clearly indictaes that temperature differences exist between sites on a seasonal basis and that some sites warmed at a much greater rate when compared to others.

```{r define_fun5, include=TRUE}
clust_plot2 <- function(df){
  plot2 <- df %>%
    ungroup() %>% 
    mutate(index_pair = addline_format(index_pair)) %>% 
    ggplot(aes(x = year, y = temp_mean_month_year)) +
    geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7, show.legend = F) +
    geom_smooth(method = "gam", se = F, aes(colour = index_pair), show.legend = T)  +
    labs(x = "Year", y = "Average temperature (°C)") +
    facet_wrap(~ month) +
    theme_bw() +
    guides(fill=guide_legend(title = "Paired\nsites")) +
    theme(axis.text = element_text(size = 18),
          axis.title = element_text(size = 20),
          legend.text = element_text(size = 18),
          legend.title = element_text(size = 20))
  return(plot2)
}
```

```{r run_fun5, fig.cap = "Line graphs representing the monthly average temperatures between two sites (° Celsius). Each graphic showing a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided. The linear lines are the linear models in their respective colours ", fig.height = 20, fig.width = 20}
(SACTN_clust_1_plot2 <- clust_plot2(df = SACTN_clust_1_matched))
(SACTN_clust_2_plot2 <- clust_plot2(df = SACTN_clust_2_matched))
(SACTN_clust_3_plot2 <- clust_plot2(df = SACTN_clust_3_matched))
(SACTN_clust_4_plot2 <- clust_plot2(df = SACTN_clust_4_matched))
(SACTN_clust_5_plot2 <- clust_plot2(df = SACTN_clust_5_matched))
(SACTN_clust_6_plot2 <- clust_plot2(df = SACTN_clust_6_matched))

combined2_plot <- ggarrange(SACTN_clust_1_plot2, SACTN_clust_2_plot2,
                           SACTN_clust_3_plot2, SACTN_clust_4_plot2, 
                           SACTN_clust_5_plot2, SACTN_clust_6_plot2, ncol = 2, nrow = 3)
combined2_plot

ggsave(plot = combined2_plot, filename = "figures/combined2_plot.pdf")
```

To further show changes in temperatures between sites within clusters we also assessed the standard deviations of the temperature differences.

```{r define_fun7, include=TRUE}
clust_plot3 <- function(df){
  plot3 <- df %>%
    ggplot(aes(x = year, y = temp_sd_month_year)) +
  geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7) +
  geom_smooth(method = "gam", se = F, aes(colour = index_pair))  +
  facet_wrap(~month) +
  theme_pubclean()
  return(plot3)
}
```

```{r run_fun7, include = TRUE, fig.cap = "fig.cap = "Line graph representing the standard deviation of the monthly temperatures (° Celsius). Each graphic shows a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot3 <- clust_plot3(df = SACTN_clust_1_matched)
# SACTN_clust_1_plot3
SACTN_clust_2_plot3 <- clust_plot3(df = SACTN_clust_2_matched)
# SACTN_clust_2_plot3
SACTN_clust_3_plot3 <- clust_plot3(df = SACTN_clust_3_matched)
# SACTN_clust_3_plot3
SACTN_clust_4_plot3 <- clust_plot3(df = SACTN_clust_4_matched)
# SACTN_clust_4_plot3
SACTN_clust_5_plot3 <- clust_plot3(df = SACTN_clust_5_matched)
SACTN_clust_6_plot3 <- clust_plot3(df = SACTN_clust_6_matched)


plot3_final <- ggarrange(SACTN_clust_1_plot3,SACTN_clust_2_plot3,
                         SACTN_clust_3_plot3,SACTN_clust_4_plot3,
                         SACTN_clust_5_plot3, SACTN_clust_6_plot3)
plot3_final
```

### Load wave data

Creating a function which allows me to load the wave data:

```{r define_fun8, include=TRUE}
load_wave <- function(wave_files) {
  site_name <- sapply(strsplit(as.character(wave_files), "/"), "[[", 3)
  site_info <- sapply(strsplit(as.character(wave_files), "/"), "[[", 4)
  site_info <- sapply(strsplit(site_info, ".txt"), "[[", 1)
  site_info <- strsplit(site_info, "_")
  site_depth <- sapply(site_info, "[[", 1)
  site_num <- sapply(site_info, "[[", 2)
  
  wave <- read_table(wave_files, col_types = c("dddddd"),
                     col_names = c("date", "hs", "tp", "dir", "dirw", "spw")) %>%
    filter(tp != -999) %>%
    mutate(date = as.POSIXct(as.character(date), "%Y%m%d%H%M", tz = "Africa/Johannesburg")) %>%
    mutate(site = site_name,
           num = site_num,
           depth = site_depth) %>%
    select(site, num, depth, everything()) %>% 
    na.omit()
  return(wave)
}
```

Loading the wave data for the sites along the South African coast:

```{r run_fun8 load_files3, include = TRUE}
saldanha_bay <- map_dfr(dir("data/wave_data/Saldanha Bay",
                        full.names = TRUE, pattern = "*.txt"), load_wave)
gansbaai <- map_dfr(dir("data/wave_data/Gansbaai", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
gordons_bay <- map_dfr(dir("data/wave_data/Gordons Bay", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
kalk_bay <- map_dfr(dir("data/wave_data/Kalk Bay", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
muizenberg <- map_dfr(dir("data/wave_data/Muizenberg", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
lamberts_bay <- map_dfr(dir("data/wave_data/Lamberts Bay", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
port_nolloth <- map_dfr(dir("data/wave_data/Port Nolloth", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
port_edward <- map_dfr(dir("data/wave_data/Port Edward", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
eastern_beach <- map_dfr(dir("data/wave_data/Eastern Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
hamburg <- map_dfr(dir("data/wave_data/Hamburg", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
orient_beach <- map_dfr(dir("data/wave_data/Orient Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
stilbaai <- map_dfr(dir("data/wave_data/Stilbaai", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
bordjies <- map_dfr(dir("data/wave_data/Bordjies", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
knysna <- map_dfr(dir("data/wave_data/Knysna", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
port_edward <- map_dfr(dir("data/wave_data/Port Edward", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
to_strand <- map_dfr(dir("data/wave_data/T.O. Strand", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
leisure_bay <- map_dfr(dir("data/wave_data/Leisure Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
sea_point <- map_dfr(dir("data/wave_data/Sea Point", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
mossel_bay <- map_dfr(dir("data/wave_data/Mossel Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

wave_data <- rbind(bordjies, gansbaai, gordons_bay, kalk_bay, lamberts_bay, muizenberg, port_nolloth, port_edward,eastern_beach, hamburg, orient_beach, stilbaai, mossel_bay, knysna, to_strand, leisure_bay, sea_point, saldanha_bay)

rm(bordjies, gansbaai, gordons_bay, kalk_bay, lamberts_bay, muizenberg, port_nolloth, port_edward,eastern_beach, hamburg, orient_beach, stilbaai, mossel_bay, knysna, to_strand, leisure_bay, sea_point, saldanha_bay)
```

## Converting 3-hour resolution data into daily data

Converting the 3-hour resolution wave data into daily data. https://cran.r-project.org/web/packages/circular/circular.pdf (Pg 130). The circular function creates circular objects around the wind and wave direction. The wave and wind direction was collected every three hours and by using the circular function we calcuated the daily mean wave and wind direction. There is a numerically large gap between 360 and 2 where as in degrees its not as large. The circular mean function returns the mean direction of a vector of circular data.

```{r}
wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean.circular(circular(dir, units = "degrees")),
            dirw_circ = mean.circular(circular(dirw, units = "degrees")),
            spw_circ = mean.circular(circular(spw, units = "degrees")),
            hs_circ = mean.circular(circular(hs, units = "degrees")),
            tp_circ = mean.circular(circular(tp, units = "degrees"))) 
```

## Dividing the data into two different depths

Here I am splitting the daily wave data into depths of 7m and 15m respectivley

```{r}
sites_complete_7a <- wave_daily %>%
  filter(depth == "7m")

sites_complete_15a <- wave_daily %>%
  filter(depth == "15m")
```

## Matching temperature with the wave data

Here I match the SACTN temperature data with the wave data based on the site and date. 

```{r}
SACTN_daily_clusters_sub_1 <- SACTN_daily_clusters_sub %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

try1 <- function(df) {
  func1 <- df %>% 
    left_join(sites_complete_7a, by = c("site", "date")) %>% 
    na.trim() %>% 
    group_by(site)
    return(func1)
}
try2 <- function(df) {
  func2 <- df %>% 
    left_join(sites_complete_15a, by = c("site", "date")) %>% 
    na.trim() %>% 
    group_by(site)
    return(func2)
}

SACTN_daily_clusters_7a <- try1(df = SACTN_daily_clusters_sub_1)
SACTN_daily_clusters_15a <- try2(df = SACTN_daily_clusters_sub_1)
```

































































