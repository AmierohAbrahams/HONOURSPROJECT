---
title: "Methods"
author: "Amieroh Abrahams"
date: "7 May 2018"
output:
  word_document:
    toc: yes
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    highlight: default
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
  pdf_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    highlight: zenburn
    latex_engine: xelatex
mainfont: PT Serif
monofont: PT Mono
language: Australian
sansfont: PT Sans
fontsize: 12pt
---

## Methods

First I need to find, install and load various packages. These packages will be available on CRAN and can be accessed and installed in the usual way.

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(ggpubr)
library(zoo)
library(lubridate)
library(ggrepel)
library(FNN)
library(stringr)
```

Now to get to the data. The first step involves the loading of the site list.

```{r load_files1, include=TRUE}
load("data/site_list_v4.2.RData")
```

AJS: Throughout all of this (maybe preceding each step in the analysis) I also want to see why the things you do are done, not only how they are done. This shows me the reasoning that goes into the approach being followed. These things correspond to the justification/rationale sections of research. I would also like to the the justifications being based on a knowledge/understanding of the literature---what gaps are you addressing, and why, and why do you recon addressing these gaps are important? Please do this THROUGHOUT the document here. I'm not expecting that everything gets attended to at once, but I'd like to check progress each week, and I would therefore like to see how these gaps are addressed systematicalluy, week after week.

Performing the k-means clustering on a data matrix using the `kmeans()` function, which uses multiple random seeds to find a number of clusting solutions; it selects as the final solution the one that has the minimum total within-cluster sum of squared distances. K-means attempts to minimise distortion. At the minimum, all cluster centres are at the mean of the set of data points which are nearest to the cluster centre. The data contain variables from many sites along the South African coast, but in the analysis I use only some of them. These variables are the mean, min and max.

```{r setup_k-means, include=TRUE}
set.seed(10)
kmeans(site_list[,c(15, 18, 19)], 3)$cluster
clust_columns <- site_list[,c(15, 18:19)]
```

Visualisation of the clusters. My plotting functions partition the data into the clusters and colour code each point accordingly so that I am able to see patterns that exist.

```{r define_fun1, include=TRUE}
clust_i <- function(i) {
  set.seed(10)
  ggplot(data = site_list,
         aes(x = lon, y = lat,
             colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    borders() +
    geom_point() +
    labs(colour = "cluster") +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
    ggtitle(paste0("clust = ", i))
}
```

```{r run_fun1, include=TRUE}
clust_6 <- clust_i(6)
clust_5 <- clust_i(5)
clust_4 <- clust_i(4)
clust_3 <- clust_i(3)

clusters <- ggarrange(clust_6, clust_5, clust_4, clust_3, common.legend = T)
clusters
```

It is now necessary to load the SACTN dataset. The SACTN dataset comprise of 129 *in situ* coastal seawater temperatures derived from daily measurements over up to 40 years. Clustering the sites using the k-means results:

```{r load_files2, include=TRUE}
load("SACTN_data/SACTN_daily_v4.2.RData")
```

Creating a cluster index whilst only selecting cluster 4. Working with at least one decade of data for each of the sites along the coast, and not using any time series deeper than a five metres.

```{r run_k-means, include=TRUE}
set.seed(10)
site_list$cluster <- as.factor(kmeans(site_list[,c(15, 18:19)], 4)$cluster)

site_list_clusters <- site_list %>% 
  filter(length >= 3650, depth <= 5)

SACTN_daily_clusters <- left_join(SACTN_daily_v4.2, site_list[,c(4, 13, 21)]) %>% 
  filter(index %in% site_list_clusters$index) 
```

With the sites now split into four clusters, the next step is to reduce the number of sites per cluster down to a manageable, but still representative, sub-sample of the whole. This is done primarily for two reasons. The first, simply, is to allow for the comparisons to be more readily interpretable by humans. The second more objective reason is to allow for an equal amount of sampling per cluster. The East coast is much more heavily sampled than the rest and so this imbalance must be addressed. The criteria that must be considered for the sub-samples are that both instrument types (UTR and thermometer) are present, and as many sources are included as are possible.

AJS: There's also criteria to do with duration of the time series, the instrument depth, etc. After the sites have been selected and clustering done, I'd suggest also writing bits (with relevant literature cited) about why these patterns exist, what drove the clustering, and which oceanographic forcings are thought to drive the patterns/processes there.


```{r site_sub_samples, include=TRUE}
# First simply divide up the site list by cluster
sites_1 <- site_list_clusters %>%
  filter(cluster == 1)
sites_2 <- site_list_clusters %>%
  filter(cluster == 2)
sites_3 <- site_list_clusters %>%
  filter(cluster == 3)
sites_4 <- site_list_clusters %>%
  filter(cluster == 4)

# I then grouped the sub-samples by source and took the longest time series
# When fewer than 4 sources were present, I took the next longest time series etc.
sites_1_sub <- sites_1 %>%
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  ungroup()
sites_2_sub <- sites_2 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup()
sites_3_sub <- sites_3 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,4,6,7)) 
# These sites don't all overlap...
sites_4_sub <- sites_4 %>% 
  filter(src != "SAWS") %>% # The one SAWS time series available is rather bad
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  filter(NA.perc %in% tail(NA.perc, 2)) %>%
  ungroup() %>% 
  slice(c(1,4,7,9))
#
# This then creates subsets of the four sites per cluster
# Though we may want to consider the distance between sites as well...
# Anyway, for now I stitch them together to be used as a further index
# for subsetting the daily data
site_list_sub <- rbind(sites_1_sub, sites_2_sub, sites_3_sub, sites_4_sub)
# write_csv(site_list_sub, path = "data/site_list_sub.csv")

# Then subset the daily data
SACTN_daily_clusters_sub <- SACTN_daily_clusters %>%
  filter(index %in% site_list_sub$index)
```

The function droplevels is used here to drop unused levels from the factor such as the length column. The unique function is then used to determine the amount sites found within this cluster:

```{r, include=TRUE}
# SACTN_clust_1 <- SACTN_daily_clusters %>%
#   filter(cluster == 1) %>%
#   select(-length) %>%
#   droplevels()
# length(unique(SACTN_clust_1$index))
```

Creating a function matching the sites:

```{r define_fun2, include=TRUE}
## testing...
# df <- SACTN_daily_clusters
# clust <- 1
##
clust_match <- function(df, clust) {
  SACTN_clust_x_match <- data.frame()
  df2 <- df %>%
    filter(cluster == clust) %>%
    select(-length) %>%
    droplevels()
  for (i in 1:length(levels(df2$index))) {
    # for (i in 1:10) {
    SACTN_df_1 <- filter(df2, index == levels(index)[i])
    for (j in 1:length(levels(df2$index))) {
      # for(j in 1:10) {
      if (i == j) {
        next
      }
      if (j < i) {
        next
      }
      SACTN_df_2 <- filter(df2, index == levels(index)[j])
      SACTN_df_3 <- left_join(SACTN_df_1, SACTN_df_2, by = "date") %>%
        na.trim() %>%
        select(date, index.x, temp.x, index.y, temp.y, -cluster.x, -cluster.y) %>%
        rename(index_1 = index.x,
          temp_1 = temp.x,
          index_2 = index.y,
          temp_2 = temp.y) %>%
        mutate(index_pair = paste0(index_1, " - ", index_2))
      SACTN_clust_x_match <- rbind(SACTN_clust_x_match, SACTN_df_3)
    }
  }
  return(SACTN_clust_x_match)
}
```

I calculated the monthly mean temperature and standard deviation for each year and site found in cluster 1. Consequently we have a data frame with 5 columns and a row for each of months per year.

```{r run_fun2, include=TRUE}
# Calculate all of the matche-ups in cluster 1
SACTN_clust_1_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 1)
SACTN_clust_2_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 2)
SACTN_clust_3_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 3)
SACTN_clust_4_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 4)

clust_legit <- function(df) {
  SACTN_clust_x_legit <- df %>%
  mutate(temp_legit = temp_1-temp_2,
         month = month(date, abbr = T, label = T),
         year = year(date)) %>%
  select(-temp_1, -temp_2) %>%
  group_by(index_pair, month, year) %>%
  summarise(temp_mean_month_year = mean(temp_legit, na.rm = T),
            temp_sd_month_year = sd(temp_legit, na.rm = T))
  return(SACTN_clust_x_legit)
}

SACTN_clust_1_legit <- clust_legit(df = SACTN_clust_1_match)
SACTN_clust_2_legit <- clust_legit(df = SACTN_clust_2_match)
SACTN_clust_3_legit <- clust_legit(df = SACTN_clust_3_match)
SACTN_clust_4_legit <- clust_legit(df = SACTN_clust_4_match)
```

The code below lets us visualise the temperature variation at each of the sites found in cluster 1.

```{r define_fun3, include=TRUE}
clust_plot <- function(df) {
  plot1 <- df %>%
    select(-index_1, -index_2) %>% 
    gather(key = "temp_grp", val = "temp", -date, -index_pair) %>% 
    ggplot(aes(x = index_pair)) +
    geom_boxplot(aes(y = temp, fill = temp_grp), alpha = 0.3) +
    scale_fill_manual(values = c("khaki4", "chartreuse3")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  return(plot1)
}
```

```{r run_fun3,  fig.cap = "Boxplots representing the different site locations along the South African coast represented by various temperature parameters. Temperature parameters include minimum, maximum and mean temperatures (°C). The Boxplots represent the minimum, 25th percentile, median and 75th percentile of the temperatures measured. The interquartile can be dedudced by the difference between the percentiles with the dots representing the outliers in the data.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot1 <- clust_plot(df = SACTN_clust_1_match)
# SACTN_clust_1_plot1
SACTN_clust_2_plot1 <- clust_plot(df = SACTN_clust_2_match)
# SACTN_clust_2_plot1
SACTN_clust_3_plot1 <- clust_plot(df = SACTN_clust_3_match)
# SACTN_clust_3_plot1
SACTN_clust_4_plot1 <- clust_plot(df = SACTN_clust_4_match)
# SACTN_clust_4_plot1

combined_plot <- ggarrange(SACTN_clust_1_plot1,SACTN_clust_2_plot1,SACTN_clust_3_plot1,SACTN_clust_4_plot1)
combined_plot
```


Temperatures were not uniformly distributed across our four clusters formed from Cluster three, with each set of sites having unique patterns of temperature variation. In cluster 1, which includes Cape Agulhas, Gansbaai, Mossel Bay, and Ystervarkpunt, we have a range of temperatures that varies between approximately 10 ºC to 24 ºC. Within this cluster of sites, we found that Mossel Bay had both the lowest minimum and highest maximum temperatures between the four sites, and had a comparatively tall box plot. This showed that Mossel Bay had the largest amount of variation in temperature within this cluster. Conversely, Gansbaai had the lowest amount of temperature variation as it had a relatively short box plot. Cape Agulhas and Ystervarkpunt had relatively similar ranges and distributions of temperature data as evident by their plots nearly overlapping completely. For each of these sites, temperature distribution was always skewed towards higher temperatures.

In the cluster consisting of Gordons Bay, Kalk Bay, Muizenberg, and Tsitsikamma, we find overall lower temperatures than those of the first cluster. In this cluster, temperatures ranged from between approximately 8ºC to 24ºC, with most box plots being relatively short. Whilst the overall range was similar to the first cluster, here the upper quartiles of temperatures were considerably and consistently lower than at the sites within the first cluster. Muizenberg had the widest variation of temperatures out of the four sites, with the remaining three having relatively similar temperature variations. As such, with the exception of comparisons relating to Muizenberg, each of the box plots greatly overlapped with one another with relatively few differences between them. Median temperatures across sites were nearly identical, with each being close to approximately 16ºC.

The third cluster had significantly <AJS: you cannot say *significant* as no stats was done to show this> lower temperatures than the others. In this cluster, which consisted of Honderklipbaai, Oudekraal, Patternoster, and Port Nolloth, we found much taller box plots with lower temperatures throughout (RWS: The boxplots are not taller in cluster 3. Rather, the y-axis is smaller than the other clusters, so they appear taller. Be careful about making comparisons between graphs). Temperatures within this cluster ranged from approximately 6.5ºC to 17ºC, with the average median temperature being close to 12ºC across all four sites. Oudekraal had the largest variation of temperature across sites, and had a large amount of skewness towards lower temperatures. Conversely, Patternoster has relatively low variation in temperature as it had a comparatively short box plot with relatively evenly distributed temperatures. Port Nolloth, Patternoster, and Honderklipbaai were relatively similar in terms of temperature variances, as their box plots were largely overlapping with little differences between them. There were however several outliers present within the temperatures of these sites.

The fourth cluster comprised of Aliwal Shoal, Sodwana, Glenmore, and Port Edward. Overall, the temperatures of these sites were higher than those of the sites within the other clusters, with a range of between 16.5ºC to 27.5ºC, which is considerably higher than that of the others. Box plots were all relatively short, and had little skewness. Temperatures differed greatly between these four sites however, with most of the box plots not overlapping very well. Sodwana had considerably more high temperatures than that of Port Edward and Glenmore. Median temperatures thus greatly differed amongst these four sites.

(RWS: I think it would be useful to include normal boxplots of the sites in each cluster as well. The boxplots above show the comparisons for overlapping temperatures, but they don't give the exact representation of what the temperatures are in each time series. I think it could look good to create a two-panel boxplot figure for each cluster. The top panel would show normal boxplots and the bottom panel would show these types of box plots. One two-panel figure for each cluster.)

Now I make a visualisation to reveal the relationship between the mean temperature for each month of each year over time for each of the sites in cluster:

```{r define_fun4, include=TRUE}
clust_plot2 <- function(df){
  plot2 <- df %>%
    ggplot(aes(x = year, y = temp_mean_month_year)) +
    geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7, show.legend = F) +
    geom_smooth(method = "gam", se = F, aes(colour = index_pair), show.legend = T)  +
    facet_wrap(~month) +
    theme_pubclean()
  return(plot2)
}
```

```{r run_fun, fig.cap = "Line graphs representing the monthly average temperatures between two sites (° Celsius). Each graphic showing a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided. The linear lines are the linear models in their respective colours ", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot2 <- clust_plot2(df = SACTN_clust_1_legit)
# SACTN_clust_1_plot2
SACTN_clust_2_plot2 <- clust_plot2(df = SACTN_clust_2_legit)
# SACTN_clust_2_plot2
SACTN_clust_3_plot2 <- clust_plot2(df = SACTN_clust_3_legit)
# SACTN_clust_3_plot2
SACTN_clust_4_plot2 <- clust_plot2(df = SACTN_clust_4_legit)
# SACTN_clust_4_plot2

plot2_final <- ggarrange(SACTN_clust_1_plot2,SACTN_clust_2_plot2,SACTN_clust_3_plot2,SACTN_clust_4_plot2)
plot2_final
```

On a monthly basis, between 1990 to 2016, the rates of changes in differences of average temperatures between sites within cluster 1 (Cape Agulhas, Gansbaai, Mossel Bay, and Ystervarkpunt) varied on an apparent seasonal basis. During the summer months we saw that there were large differences in average temperatures between Gansbaai and the remaining three sites, and that the rate of changes between these rapidly increased on yearly basis <AJS: I don't see how you can conclude from these graphs that the rates of change rapidly increased on a yearly basis... but the preceding statement seems correct. I think this should be tested statistically... We need to figure out a way to do an ANCOVA to test the constancy of slopes seasonally.>. Towards the end of summer and autumn months, in addition to the continuing trends observed between Gansbaai and the remaining sites, we then also saw an increase in the rate of change <AJS: again, "increase in rate of change" cannot be inferred from linear models...> in differences between Cape Agulhas and Mossel Bay, and Ystervarkpunt respectively. During winter we see very little differences in average temperatures between all four sites, and this remained relatively stable over the time period. During spring months there was an increase in the rate of change of average temperatures between Cape Agulhas and Gansbaai which continues into summer. <AJS: I like this finding. We should have a meeting with Rob W soon as he also have some new funky data that I think corrobotae your analysis.>

Conversely to the first cluster, in the cluster containing Kalk Bay, Gordons Bay, Muizenberg and Tsitsikamma the largest rates of changes were observed during autumn and winter months. In this cluster we saw large differences in average temperatures between Muizenberg and the remaining sites, with the differences increasing annually throughout 1972 and 2016 during winter <AJS: this is a correct statement that I can live with.>. Similarly, the rates of changes in differences of average temperatures also increased between Kalk Bay and Muizenberg during these same months. In the summer and spring months we saw relatively little differences in average temperatures between sites, with minimal differences in the rates of these changes over the 44 year time period. These rates increased during spring.

In the cluster that was comprised of Hondeklipbaai, Oudekraal, Patternoster, and Port Nolloth, we found large differences in average temperatures between sites at certain months between 1990 and 2016. The rate of change in the difference of average temperatures between Port Nolloth and Oudekraal increased every month for this time period, and was most prominent during spring and summer. There were also large increases in the rate of change between differences of average temperature between Peternoster and Oudekraal throughout spring. For the remining sites, differences in average temperatures were relatively low throughout each month, with relatively stable rates of change.

In  the forth cluster, which was comprised of Aliwal Shoal, Glenmore, Port Edward, and Sodwana, we found large changes in the differences of average temperatures between sites on a monthly basis between 1980 and 2016. Here, the biggest changes occurred in the month of April. In this month we saw a steep increase in the rate of change of differences of average temperature between Aliwal Shoal and Sodwana, and Aliwal Shoal and Port Edward. Additionally, there was a large difference in average temperature between Port Edward and Sodwana, with the most prominent increase in the rate of change <AJS: no.> occurring during the autumn and winter months.

Now I make a visualisation to reveal the relationship between the sd of the temperatures for each month of each year for each of the sites in the clusters.

```{r define_fun5, include=False}
clust_plot3 <- function(df){
  plot3 <- df %>%
    ggplot(aes(x = year, y = temp_sd_month_year)) +
  geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7) +
  geom_smooth(method = "gam", se = F, aes(colour = index_pair))  +
  facet_wrap(~month) +
  theme_pubclean()
  return(plot3)
}
```

```{r run_fun, include = True, fig.cap = "fig.cap = "Line graph representing the standard deviation of the monthly temperatures (° Celsius). Each graphic shows a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot3 <- clust_plot3(df = SACTN_clust_1_legit)
# SACTN_clust_1_plot3
SACTN_clust_2_plot3 <- clust_plot3(df = SACTN_clust_2_legit)
# SACTN_clust_2_plot3
SACTN_clust_3_plot3 <- clust_plot3(df = SACTN_clust_3_legit)
# SACTN_clust_3_plot3
SACTN_clust_4_plot3 <- clust_plot3(df = SACTN_clust_4_legit)
# SACTN_clust_4_plot3

plot3_final <- ggarrange(SACTN_clust_1_plot3,SACTN_clust_2_plot3,SACTN_clust_3_plot3,SACTN_clust_4_plot3)
plot3_final
```

<AJS: I stopped here this time. Plenty for you to do in the meanwhile.>

To further show changes in temperatures between sites within clusters we also assessed the standard deviations of the temperature differences. In the cluster consisting of Cape Agulhas, Gansbaai, Mossel Bay, and Ystervarkpunt, we found relatively little differences in changes to standard deviation. The most variation occurred towards the end of the summer season within the months of February, March, and April. The changes in standard deviation were mostly seen between Ystervarkpunt and Mossel Bay, throughout the above mentioned months as well as in December, and between Gaansbaai and Ystervarkpunt through the same time period where the rates of standard deviation fluctuations differed. Throughout the remaining months, standard deviations of the differences in temperature were relatively similar and did not vary much across all sites.

We found similar trends within the cluster containing Gordons Bay, Kalk Bay, Muizenberg, and Tsitsikamma. Here, again we found that there were very few changes in standard deviations for sites within most months except those towards the end of summer and spring seasons. Most variation was found within the months of February, March, and April, and mostly occurred between Kalk Bay and Tsitsikamma. Most sites had very straight trend lines and did not have any apparent differences in standard deviations of temperature differences across their overlapping time period.

In the cluster containing Hondeklipbaai, Patternoster, Port Nolloth, and Oudekraal, the biggest shifts in standard deviations of temperature between sites were most prominent during summer. Here, changes in differences of standard deviations fluctuated greatly in November, December, and Januaury. Most variation occurred within November, and seemingly occurred across all four sites as seen by the large slopes in the trend lines. Conversely, winter months had relatively little differences between standard deviations of temperatures across sites apart from Port Nolloth and Oudekraal which fluctuated throughout, as well as Hondeklipbaai and Oudekraal which had steep linear model lines throughout each month.

The cluster containing Aliwal Shoal, Glenmore, Port Edward, and Sodwana had relatively little changes in standard deviations of temperature differences between sites over the overlapping time periods. Here, we saw that most variation occurred within the months of March, April, and May where there were changes between Sodwana and Aliwal Shoal, Glenmore, and Port Edward respectively. Throughout the remaining months there were relatively little changes in differences of standard deviations of temperature differences between sites as most linear models produced straight lines across the overlapping time periods.

Map showing the location of each site within each of the four clusters

```{r}
library(ggrepel)

# site_coordinates1 <- filter(site_list_sub, cluster == 1) %>% 
#   select(site, lon, lat)
# write_csv(site_coordinates1, path = "Mapping/site_coordinates1.csv")
# site_coordinates2 <- filter(site_list_sub, cluster == 2) %>% 
#   select(site, lon, lat)
# write_csv(site_coordinates2, path = "Mapping/site_coordinates2.csv")
# site_coordinates3 <- filter(site_list_sub, cluster == 3) %>% 
#   select(site, lon, lat)
# write_csv(site_coordinates3, path = "Mapping/site_coordinates3.csv")
# site_coordinates4 <- filter(site_list_sub, cluster == 4) %>% 
#   select(site, lon, lat)
# write_csv(site_coordinates4, path = "Mapping/site_coordinates4.csv")

# Creating graphs to better view and understand the site location
# Clusters in clus 1
# cluster 1
# Cape agulhas
# Ystervarkpunt
# mossel bay
# Gansbaai


# Loading the data --------------------------------------------------------
load("Mapping/3_site_clustering/sa_provinces.RData")
site_coordinates1 <- read_csv("Mapping/site_coordinates1.csv")
load("Mapping/south_africa_coast.RData")


# mapping -----------------------------------------------------------------


ggplot(data = site_coordinates1, aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = site_coordinates1)  +
  geom_label_repel(data =site_coordinates1, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, segment.alpha = 0.4) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())

# cluster 2
# Gordons Bay
# Tsitsikamma
# Kalk Bay
# Muizenberg
site_coordinates2 <- read_csv("Mapping/site_coordinates2.csv")
ggplot(data = site_coordinates2, aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = site_coordinates2)  +
  geom_label_repel(data =site_coordinates2, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, segment.alpha = 0.4) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())
# cluster 3
# Hondeklipbaai
# Oudekraal
# Paternoster
# Port Nolloth
site_coordinates3 <- read_csv("Mapping/site_coordinates3.csv")
ggplot(data = site_coordinates3, aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = site_coordinates3)  +
  geom_label_repel(data =site_coordinates3, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, segment.alpha = 0.4) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())

# cluster 4
# Aliwal Shoal
# Sodwana
# Glenmore
# Port Edward
site_coordinates4 <- read_csv("Mapping/site_coordinates4.csv")
ggplot(data = site_coordinates4, aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = site_coordinates4)  +
  geom_label_repel(data =site_coordinates4, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, segment.alpha = 0.4) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())
```

Creating a function which allows me to load all the wave data:

```{r define_fun4}
test_func <- function(wave_files) {
  site_type <- sapply(strsplit(as.character(wave_files), "/"), "[[", 3)
  site_num <- sapply(strsplit(as.character(wave_files), "/"), "[[", 4)
  site_num <- sapply(strsplit(site_num, ".txt"), "[[", 1)
  site_name <- paste(site_type, site_num, sep = "")

  try1 <- read.csv(wave_files, col.names = c("date", "hs", "tp", "dir", "dirw", "spw"), sep = "", header = F) %>%
    filter(tp != -999) %>%
    mutate(date = as.POSIXct(as.character(date), "%Y%m%d%H%M", tz = "Africa/Johannesburg")) %>%
    mutate(site = site_name) %>%
    select(site, everything())
  return(try1)
}
```

Feeding as a vector:

```{r, include=TRUE}
trial_load <- function(directory) {
  files_list <- dir(directory, full.names = TRUE)
  final <- plyr::ldply(files_list, test_func, .progress = "text")
  return(final)
}
```

Loading the wave data for the sites along the South African coast:

```{r, include=TRUE}
sites_complete <- read_csv("data/sites_complete.csv") %>%
  select(-site_list) %>%
  rename(site_real = site) %>%
  gather(key = "depth", value = "site", -site_real, -lon, -lat)

FB <- trial_load("data/wave_data/FB")
TB <- trial_load("data/wave_data/TB")
HE <- trial_load("data/wave_data/HE")
SH <- trial_load("data/wave_data/SH")

wave_data <- rbind(FB, TB, HE, SH)
wave_data <- left_join(wave_data, sites_complete) %>%
  rename(site_wave = site,
         site = site_real)
rm(FB, TB, HE, SH)
```

Converting the 3-hour resolution wave data into daily data. The funs function, funs(), is used here as it provides a flexible way to generate a named list of functions for input to other functions such as the mean and sd:

```{r, include=TRUE}
wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, site_wave, depth, lon, lat, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = T) %>%
  ungroup()
```

Calculating the annual wave data for each of the sites excluding the year 2000:

```{r, include=TRUE}
wave_annually <- wave_data %>%
  mutate(date = lubridate::year(date)) %>%
  group_by(site, site_wave, depth, lon, lat, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = TRUE) %>%
  ungroup() %>%
  filter(date != 2000)
```

Now splitting the wave data into the different depths; either a depth of 7m or a depth of 15m:

```{r unique_name1}
sites_complete_7 <- sites_complete %>%
  filter(depth == "wave_7")

sites_complete_15 <- sites_complete %>%
  filter(depth == "wave_15")
```

Creating a time series over a period of 10 years:

```{r}
site_list_10_years <- site_list %>%
  filter(index %in% SACTN_daily_clusters$index)
```

Using the FNN package to determine the nearest wave data for each of the SACTN sites present in this cluster. Once that was determined only waves minimised to only include the 7 and 15m depths. Thereafter wave 7 and wave 15 was combined and all unnessasary infomationwas removed and the cluster column was then added to the sites infomation:

```{r unique_name2}
waves_idx_7 <- as.data.frame(knnx.index( as.matrix(sites_complete_7[,2:3]), as.matrix(site_list_10_years[,5:6]), k = 1))
waves_idx_15 <- as.data.frame(knnx.index( as.matrix(sites_complete_15[,2:3]), as.matrix(site_list_10_years[,5:6]), k = 1))

sites_complete_subset_7 <- sites_complete_7[as.matrix(waves_idx_7),]
sites_complete_subset_15 <- sites_complete_15[as.matrix(waves_idx_15),]
```

```{r}
sites_complete_subset <- cbind(sites_complete_subset_7, sites_complete_subset_15[,4:5])
colnames(sites_complete_subset)[c(5, 7)] <- c("wave_7", "wave_15")
sites_complete_subset <- sites_complete_subset[, c(1:3, 5, 7)]

site_list_match <- cbind(site_list_10_years[,c(4:6,20)], sites_complete_subset)
colnames(site_list_match) <- c("index", "lon1", "lat1", "cluster", "site_real", "lon2", "lat2", "wave_7", "wave_15")
```

Creating a function using the haversine formula to calculate the geodesic distance between two points specified by radian lat/lon, which is the shortest distance over the earth’s surface. This formula is particularly well-conditioned for numerical computations at both large and small scales:

```{r define_fun5}
deg2rad <- function(deg) return(deg*pi/180)
gcd.hf <- function(long1, lat1, long2, lat2) {
  R <- 6371
  delta.long <- (long2 - long1)
  delta.lat <- (lat2 - lat1)
  a <- sin(delta.lat/2)^2 + cos(lat1) * cos(lat2) * sin(delta.long/2)^2
  c <- 2 * asin(min(1,sqrt(a)))
  d <- R * c
  return(d)
}
```

Creating a function to calculate matrix of distances between each two sites following the haversine formula:

```{r define_fun6}
CalcDists <- function(latlongs) {
  name <- list(rownames(latlongs), rownames(latlongs))
  n <- nrow(latlongs)
  z <- matrix(0, n, n, dimnames = name)
  for (i in 1:n) {
    for (j in 1:n) z[i, j] <- gcd.hf(long1 = latlongs[i, 1],
                                     lat1 = latlongs[i, 2], long2 = latlongs[j, 1], lat2 = latlongs[j,2])
  }
  z <- as.dist(z)
  return(z)
}
```

```{r}
PairsDists <- function(latlongs) {
  n <- nrow(latlongs)
  z <- matrix(0, n, 1, dimnames = list(latlongs[,1]))
  for (i in 1:n) {
    z[i] <- gcd.hf(long1 = latlongs[i, 2], lat1 = latlongs[i, 3],
                   long2 = latlongs[i+1, 2], lat2 = latlongs[i+1,3])
  }
  return(z)
}
```

Once the sites were matched with the sites of the 10 year time series, the distance was converted to radians. Hereafter the wave data were combined with the temperature data at a depth of 7 and 15m respectivley.

```{r unique_name3}
site_list_match_dist <- site_list_match %>%
  mutate(lon1 = deg2rad(lon1),
         lat1 = deg2rad(lat1),
         lon2 = deg2rad(lon2),
         lat2 = deg2rad(lat2),
         dist = NA)

# Creating a loop for dstances
for (i in 1:nrow(site_list_match_dist)) {
  dist <- gcd.hf(site_list_match_dist$lon1[i], site_list_match_dist$lat1[i],
                 site_list_match_dist$lon2[i], site_list_match_dist$lat2[i])
  site_list_match_dist$dist[i] <- dist
}

site_list_10_years <- left_join(site_list_10_years, site_list_match_dist[, c(1, 8:10)])

# Up next we want to combine the temperature and wave data
# First for the 7 metre depth waves
SACTN_daily_clusters_7 <- left_join(SACTN_daily_clusters, site_list_10_years[, c(4, 22)]) %>%
  left_join(wave_daily[, c(2:3, 6:16)], by = c("date", "wave_7" = "site_wave"))

# Then the 15 metre depth waves
SACTN_daily_clusters_15 <- left_join(SACTN_daily_clusters, site_list_10_years[, c(4, 23)]) %>%
  left_join(wave_daily, by = c("date", "wave_15" = "site_wave"))

SACTN_daily_clusters_7 %>%
  group_by(index) %>%
  summarise(temp_dir_cor = cor(temp, dir_mean))
```

