---
title: "Methods"
author: "Amieroh Abrahams"
date: "7 May 2018"
output:
  word_document:
    toc: yes
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    highlight: default
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
  pdf_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    highlight: zenburn
    latex_engine: xelatex
mainfont: PT Serif
monofont: PT Mono
language: Australian
sansfont: PT Sans
fontsize: 12pt
---

## Methods

### Startup

First I need to find, install and load various packages. These packages will be available on CRAN and can be accessed and installed in the usual way.

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(ggpubr)
library(zoo)
library(lubridate)
library(ggrepel)
library(FNN)
library(stringr)
library(broom)
library(purrr)
library(stlplus)
source("earthdist.R")
```

### Load SACTN data

Now to get to the data. The first step involves the loading of the site list. The statistical properties of the seawater temperature representing the South African coastline, such as the mean, minimum and maximum temperatures. These values vary among coastal sections due to the influence of the cold Benguala and warm Agulhas currents.

```{r load_files1, include=TRUE}
load("data/site_list_v4.2.RData")
load("data/sa_coast.Rdata")
```

AJS: Throughout all of this (maybe preceding each step in the analysis) I also want to see why the things you do are done, not only how they are done. This shows me the reasoning that goes into the approach being followed. These things correspond to the justification/rationale sections of research. I would also like to the the justifications being based on a knowledge/understanding of the literature---what gaps are you addressing, and why, and why do you recon addressing these gaps are important? Please do this THROUGHOUT the document here. I'm not expecting that everything gets attended to at once, but I'd like to check progress each week, and I would therefore like to see how these gaps are addressed systematicalluy, week after week.

### Clustering

Performing the k-means clustering on a data matrix using the `kmeans()` function, which uses multiple random seeds to find a number of clusting solutions; it selects as the final solution the one that has the minimum total within-cluster sum of squared distances. The data contain variables from many sites along the South African coastline, but in the analysis I use only some of them. These variables include the mean, min and max temperature values. K-means attempts group all sites with similar min, mean and max temperature values together.

```{r setup_k-means, include=TRUE}
set.seed(10)
kmeans(site_list[,c(15, 18, 19)], 3)$cluster
clust_columns <- site_list[,c(15, 18:19)]
```

The coastal region is divided into three provinces, namely the cold west coast, warm east coast and the subtropical south coast (Schlegel and Smit 2016; Smit et al 2013; Mead et al 2013). The Benguela Marine Province (BMP) is located to the west of Cape Point and is characterized by the movement of cold water from the Southern Ocean moving north. The cold temperate west coast mentioned above is greatly affected by the upwelling caused by offshore winds, generated by the cold Benguela current. Due to the small range of ambient temperatures experienced on the west coast, fluctuations are able to occur over a short period of time. The seawater temperatures found around South Africa’s coastline exhibits a large variational range. My plotting functions partition the data into the clusters and colour code each point accordingly so that I am able to see patterns that exist. The k-means function previously mentioned produced four clusters. Cluster four was selected as this represented the most accurate and distinct site groupings based on this temperature distribution. Showing a distinct east, south and west coast based on the mean, min and max temperature values.

```{r define_fun1, include=TRUE}
clust_i <- function(i) {
  set.seed(10)
  ggplot(data = site_list,
         aes(x = lon, y = lat,
             colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    borders() +
    geom_point() +
    labs(colour = "cluster") +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
    ggtitle(paste0("clust = ", i))
}

```

```{r run_fun1, include=TRUE}
clust_6 <- clust_i(6)
clust_5 <- clust_i(5)
clust_4 <- clust_i(4)
clust_3 <- clust_i(3)

clusters <- ggarrange(clust_6, clust_5, clust_4, clust_3, common.legend = T)
clusters
```

It is now necessary to load the daily SACTN temperature dataset. The SACTN dataset comprise of 135 *in situ* coastal seawater temperatures derived from daily measurements over up to 40 years. The SACTN temperature dataset was compiled by measuring coastal temperatures at 135 sites along the coast of South Africa, daily from 1972 until 2017. Temperatures were measured either manually using hand-held thermometers or electronically using underwater temperature recorders (UTRs). Of the 135 sites, 87 were measured using the thermometers and the remaining 48 were measured using UTRs. Seven sources contributed towards the compilation of this dataset; The Department of Environmental Affairs (DEA), South African Weather Services (SAWS), University of the Western Cape (UWC), Department of Forestry and Fisheries (DAFF), Kwa Zulu Natal Sharks Board (KZNSB), South African Environmental Observation Network (SAEON) and Ezemvelo KZN Wildlife Organization (EKZNW). Clustering the sites using the k-means results:

```{r load_files2, include=TRUE}
load("SACTN_data/SACTN_daily_v4.2.RData")
```

Creating a cluster index whilst only selecting cluster 4. Working with at least one decade of data for each of the sites along the coast, and excluding time series with temperature data collected deeper than a five metres. This was done to ensure that the wave data accurately matches up with the temperature data. Some of the UTR's used to collected the temperature data were placed at a depth of 18m. The wave data however is recorded at 7m and 15m respectivley. The length, decadal trend and precision of each time series were adjusted in a systematic manner. This forms the core of the analysis. The natural variability occuring between sites of each of the time series, which differs predictabily between the coastlines is affected by the Benguela and Agulhas currents.
  
```{r run_k-means, include=TRUE}
set.seed(10)
site_list$cluster <- as.factor(kmeans(site_list[,c(15, 18:19)], 4)$cluster)

site_list_clusters <- site_list %>% 
  filter(length >= 3650, depth <= 5)

SACTN_daily_clusters <- SACTN_daily_v4.2 %>% 
  left_join(site_list[,c(4, 13, 21)], by = "index") %>% 
  filter(index %in% site_list_clusters$index)
```

### Site selection

With the sites now split into four clusters, the next step is to reduce the number of sites per cluster down to a manageable, but still representative, sub-sample of the whole. This is done primarily for two reasons. The first, simply, is to allow for the comparisons to be more readily interpretable by humans. The second more objective reason is to allow for an equal amount of sampling per cluster. The East coast is much more heavily sampled than the rest and so this imbalance must be addressed. The criteria that must be considered for the sub-samples are that both instrument types (UTR and thermometer) are present, and as many sources are included as are possible.......The statistical characteristics of the seawater temperature dataset was used as to guide analyses into the suitability of the time series which allows us to produce an accurate assessment of temperature variation between sites located within the same cluster. The precision, length and decadal trend of the time series for each of the sites were adjusted systematically. 

The next step is to divide up the site list by each of the clusters present in cluster 4. Hereafter, the sites being grouped by the different sources and the longest time series for each of the sites is selected. This generates a subset of four sites per cluster.

```{r site_sub_samples, include=TRUE}
# First simply divide up the site list by cluster
sites_1 <- site_list_clusters %>%
  filter(cluster == 1)
sites_2 <- site_list_clusters %>%
  filter(cluster == 2)
sites_3 <- site_list_clusters %>%
  filter(cluster == 3)
sites_4 <- site_list_clusters %>%
  filter(cluster == 4)

# I then grouped the sub-samples by source and took the longest time series
# When fewer than 4 sources were present, I took the next longest time series etc.
sites_1_sub <- sites_1 %>%
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  ungroup()
sites_2_sub <- sites_2 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup()
sites_3_sub <- sites_3 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,4,6,7))
sites_4_sub <- sites_4 %>% 
  filter(src != "SAWS") %>% # The one SAWS time series available is rather bad
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  filter(NA.perc %in% tail(NA.perc, 2)) %>%
  ungroup() %>% 
  slice(c(1,4,7,9))
#
# This then creates subsets of the four sites per cluster
# Though we may want to consider the distance between sites as well...
# Anyway, for now I stitch them together to be used as a further index
# for subsetting the daily data
site_list_sub <- rbind(sites_1_sub, sites_2_sub, sites_3_sub, sites_4_sub)
# write_csv(site_list_sub, path = "data/site_list_sub.csv")

# Then subset the daily data
SACTN_daily_clusters_sub <- SACTN_daily_clusters %>%
  filter(index %in% site_list_sub$index)
```

### Site locations

Map showing the location of each site

```{r}
library(ggrepel)

site_coordinates1 <- filter(site_list_sub, cluster == 1) %>% 
  select(site, lon, lat)
# write_csv(site_coordinates1, path = "Mapping/site_coordinates1.csv")

site_coordinates2 <- filter(site_list_sub, cluster == 2) %>% 
  select(site, lon, lat)
# write_csv(site_coordinates2, path = "Mapping/site_coordinates2.csv")

site_coordinates3 <- filter(site_list_sub, cluster == 3) %>% 
   select(site, lon, lat)
# write_csv(site_coordinates3, path = "Mapping/site_coordinates3.csv")

site_coordinates4 <- filter(site_list_sub, cluster == 4) %>% 
  select(site, lon, lat)
# write_csv(site_coordinates4, path = "Mapping/site_coordinates4.csv")

# Loading the data --------------------------------------------------------
load("Mapping/sa_provinces.RData")
load("Mapping/south_africa_coast.RData")


# mapping -----------------------------------------------------------------
mapping_plot <- function(df){
  mapping <- df %>% 
ggplot(aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = df)  +
  geom_label_repel(data =df, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, 
                   segment.alpha = 0.4, force = 0.1) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank())
  return(mapping)
}


map_clus1 <- mapping_plot(df = site_coordinates1)
map_clus1
map_clus2 <- mapping_plot(df = site_coordinates2)
map_clus2
map_clus3 <- mapping_plot(df = site_coordinates3)
map_clus3
map_clus4 <- mapping_plot(df = site_coordinates4)
map_clus4
```

The function droplevels is used here to drop unused levels from the factor such as the length column. The unique function is then used to determine the amount sites found within this cluster:

```{r, include=TRUE}
# SACTN_clust_1 <- SACTN_daily_clusters %>%
#   filter(cluster == 1) %>%
#   select(-length) %>%
#   droplevels()
# length(unique(SACTN_clust_1$index))
```

## Calculating the distance between sites

Calculating the distance between each of the sites along the coastline. The deg2rad function transforms degrees to radians: Transforms between angles in degrees and radians. 

```{r calc-dists}
options(scipen=999) # Forces R to not use exponential notation
sa_coast_prep <- sa_coast %>% 
  mutate(site = 1:nrow(.),
         X = deg2rad(X),
         Y = deg2rad(Y)) %>% 
  select(site, X, Y)

sa_coast_dist <- as.data.frame(round(PairsDists(sa_coast_prep), 2)) %>% 
  mutate(lon = sa_coast$X,
         lat = sa_coast$Y) %>% 
  rename(dist = V1) %>%
  select(lon, lat, dist) %>% 
  mutate(cum_dist = cumsum(dist)) %>% 
  mutate(dist = lag(dist),
         cum_dist = lag(cum_dist))
```

### Matching sites

Creating a function matching the sites: This function allows me to match sites within the same cluster based on the date that temperature was collected. Sites in which temperature was collected during the same time period were matched together. This allows me to compare whether or not a temperature variation exist between sites within the same cluster and to examine the various reasons for this variation. Here we consider distance between sites. In this function the cumulative distance between sites were also calculated for each of the matching or paired sites.

```{r define_fun2, include=TRUE}
## testing...
# df <- SACTN_daily_clusters
# clust <- 1
##
clust_match <- function(df, clust) {
  SACTN_clust_x_match <- data.frame()
  df2 <- df %>%
    filter(cluster == clust) %>%
    select(-length) %>%
    droplevels()
  for (i in 1:length(levels(df2$index))) {  
    # for (i in 1:10) {
    SACTN_df_1 <- filter(df2, index == levels(index)[i])
    
    # Find the cumulative distance of site 1 along the coast
    site_dist_1 <- site_list_clusters %>% 
      filter(index == as.character(SACTN_df_1$index)[1])
    site_dist_1 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                              query = as.matrix(site_dist_1[,5:6]), k = 1)
    site_dist_1 <- sa_coast_dist$cum_dist[site_dist_1]
    
    for (j in 1:length(levels(df2$index))) {
      # for(j in 1:10) {
      if (i == j) {
        next
      }
      if (j < i) {
        next
      }
      SACTN_df_2 <- filter(df2, index == levels(index)[j])
      
      # Find the cumulative distance of site 2 along the coast
      site_dist_2 <- site_list_clusters %>% 
        filter(index == as.character(SACTN_df_2$index)[1])
      site_dist_2 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                                query = as.matrix(site_dist_2[,5:6]), k = 1)
      site_dist_2 <- sa_coast_dist$cum_dist[site_dist_2]
      
      # The distance between the two sites
      site_dist_3 <- round(abs(site_dist_1-site_dist_2), 0)
      
      SACTN_df_3 <- left_join(SACTN_df_1, SACTN_df_2, by = "date") %>%
        na.trim() %>%
        select(date, index.x, temp.x, index.y, temp.y, -cluster.x, -cluster.y) %>%
        rename(index_1 = index.x,
          temp_1 = temp.x,
          index_2 = index.y,
          temp_2 = temp.y) %>%
        mutate(index_pair = paste0(index_1, " - ", index_2, " - ", site_dist_3),
               index_dist = site_dist_3)
      SACTN_clust_x_match <- rbind(SACTN_clust_x_match, SACTN_df_3)
    }
  }
  return(SACTN_clust_x_match)
}
```

Creating a function which allows me to calculated the monthly mean temperature and standard deviation for each year and sites. Consequently we have a data frame with 7 columns and each of the rows representing each month for each of the years. By calculating the mean and SD for each site i am able identify trends in their temperatures and to compare these trends across sites within the same cluster. Mean and SD gives a broad look of the overall temperature for each of the sites. With each group of months representing the season.

```{r run_fun2, include=TRUE}
# Calculate all of the matche-ups in cluster 1
SACTN_clust_1_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 1)
SACTN_clust_2_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 2)
SACTN_clust_3_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 3)
SACTN_clust_4_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 4)

clust_matched <- function(df) {
  SACTN_clust_x_matched <- df %>%
  mutate(temp_matched = temp_1-temp_2,
         month = month(date, abbr = T, label = T),
         year = year(date)) %>%
  select(-temp_1, -temp_2) %>%
  group_by(index_pair, index_dist, month, year) %>%
  summarise(temp_mean_month_year = mean(temp_matched, na.rm = T),
            temp_sd_month_year = sd(temp_matched, na.rm = T)) %>% 
    mutate(season = ifelse(month %in% c("Jan", "Feb", "Mar"), "Summer",        
                           ifelse(month %in% c("Apr", "May", "Jun"), "Autumn",
                                ifelse(month %in% c("Jul", "Aug", "Sep"), "Winter",
                                       ifelse(month %in% c("Oct", "Nov", "Dec"), "Spring","Error")))))
  return(SACTN_clust_x_matched)
}

SACTN_clust_1_matched <- clust_matched(df = SACTN_clust_1_match)
SACTN_clust_2_matched <- clust_matched(df = SACTN_clust_2_match)
SACTN_clust_3_matched <- clust_matched(df = SACTN_clust_3_match)
SACTN_clust_4_matched <- clust_matched(df = SACTN_clust_4_match)
```

### Comparing sites

The code below lets us visualise the temperatures for each of the sites.  This box plot allows me to observe whether or not a variation exist between the sites found within the same cluster. The values represent the distance "km" between the sites Temperature 1 represents a site and temperature 2 represents a second site. The boxplot shows the temperature variation of two sites within the same cluster (along the same coast) being compared to eachother. To conclude, temperatures were not uniformly distributed with each set of sites having a unique temperature variation. 

```{r define_fun3, include=TRUE}
clust_plot <- function(df) {
  plot1 <- df %>%
    select(-index_1, -index_2) %>% 
    gather(key = "temp_grp", val = "temp", -date, -index_pair, - index_dist) %>% 
    ggplot(aes(x = index_pair)) +
    geom_boxplot(aes(y = temp, fill = temp_grp), alpha = 0.3) +
    scale_fill_manual(values = c("khaki4", "chartreuse3")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
      return(plot1)
}
```

```{r run_fun3,  fig.cap = "Boxplots representing the different site locations along the South African coast represented by various temperature parameters. Temperature parameters include minimum, maximum and mean temperatures (°C). The Boxplots represent the minimum, 25th percentile, median and 75th percentile of the temperatures measured. The interquartile can be dedudced by the difference between the percentiles with the dots representing the outliers in the data.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot1 <- clust_plot(df = SACTN_clust_1_match)
# SACTN_clust_1_plot1
SACTN_clust_2_plot1 <- clust_plot(df = SACTN_clust_2_match)
# SACTN_clust_2_plot1
SACTN_clust_3_plot1 <- clust_plot(df = SACTN_clust_3_match)
# SACTN_clust_3_plot1
SACTN_clust_4_plot1 <- clust_plot(df = SACTN_clust_4_match)
# SACTN_clust_4_plot1

combined_plot <- ggarrange(SACTN_clust_1_plot1, SACTN_clust_2_plot1,
                           SACTN_clust_3_plot1, SACTN_clust_4_plot1)
combined_plot
```

Temperatures were not uniformly distributed across our four clusters produced, with each set of sites having unique patterns of temperature variation. In cluster 1, which includes Cape Aghulus, Gansbaai, Mosterts Hoek, and Ystervarkpunt, we found that temperature varied from approximately 11 ºC to 23 ºC. Within this cluster of sites, we found that Cape Agulhas had the highest maximum temperatures and Mosterts Hoek had the lowest minimum temperatures between the four sites. Gansbaai had the lowest range of temperature variability as it produced a comparatively short box plot. Cape Aghulus and Ystervarkpunt had relatively similar ranges and distributions of temperatures as evident by their plots nearly overlapping completely. For each of these sites, temperature distribution was always skewed towards higher temperatures than lower than average temperatures.

In the cluster comprised of Gordons Bay, Kalk Bay, Muizenberg, and Hermanus, temperatures ranged from approximately 8 ºC to 25 ºC, with most box plots being relatively short. Muizenberg had the widest range of temperature variation of the four sites, and Hermanus had the narrowest range. The remaining two sites, Gordons Bay and Kalk Bay, had identical temperature ranges. Despite the apparent differences in temperature ranges between these sites, the average temperatures across these were relatively similar and near completely identical.

Sites within the third cluster had overall lower temperatures than those within the remaining clusters. This cluster consisted of Lamberts Bay, Bordjies, Betty’s Bay, and Port Nolloth, and here we found sharp declines in average temperatures throughout. Temperatures within this cluster ranged from approximately 8 ºC to 21 ºC, with the average median temperature being close to 14 ºC across all four sites. Bordjies and Betty’s Bay had the largest variation of temperature across sites. Conversely, Lamberts Bay had relatively low variation in temperature as it had a comparatively short box plot with relatively evenly distributed temperatures. Bordjies and Betty’s Bay were relatively similar in terms of temperature variances, as their box plots were largely overlapping with little differences between them. There were however several outliers present within the temperatures of these sites.

The fourth cluster comprised of Richards Bay, Antsey’s Beach, Glenmore, and Port Edward. Overall, the temperatures of these sites were higher than those of the sites within the other clusters, with a range of between 16.5 ºC to 27.5 ºC, which is considerably higher than that of the others. Box plots were all relatively short, and had little skewness. Temperatures differed greatly between these four sites however, with most of the box plots not overlapping very well. Richards Bay and Antsey’s Beach had considerably more high temperatures than that of Port Edward and Glenmore. Median temperatures thus greatly differed amongst these four sites. 

### Comparing time series

Now I create a visualisation to reveal the relationship between the mean temperature for each month of each year over time for each of the sites in cluster: This allows me to assess whether or not an average temperature differences exist between sites on a seasonal basis and to examine the intensity of this variation over the past years. It clearly indictaes that temperature differences exist between sites on a seasonal basis and that some sites warmed at a much greater rate when compared to others.

```{r define_fun4, include=TRUE}
clust_plot2 <- function(df){
  plot2 <- df %>%
    ggplot(aes(x = year, y = temp_mean_month_year)) +
    geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7, show.legend = F) +
    geom_smooth(method = "gam", se = F, aes(colour = index_pair), show.legend = T)  +
    facet_wrap(~month) +
    theme_pubclean()
  return(plot2)
}
```

```{r run_fun, fig.cap = "Line graphs representing the monthly average temperatures between two sites (° Celsius). Each graphic showing a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided. The linear lines are the linear models in their respective colours ", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot2 <- clust_plot2(df = SACTN_clust_1_matched)
# SACTN_clust_1_plot2
SACTN_clust_2_plot2 <- clust_plot2(df = SACTN_clust_2_matched)
# SACTN_clust_2_plot2
SACTN_clust_3_plot2 <- clust_plot2(df = SACTN_clust_3_matched)
# SACTN_clust_3_plot2
SACTN_clust_4_plot2 <- clust_plot2(df = SACTN_clust_4_matched)
# SACTN_clust_4_plot2

plot2_final <- ggarrange(SACTN_clust_1_plot2,SACTN_clust_2_plot2,SACTN_clust_3_plot2,SACTN_clust_4_plot2)
plot2_final
```

#### ANCOVA

Ancova analysis: This allows me to compare one variable in two or more groups taking into account the variability of other variables. This analysis of covariance is used to test the main effect of variables on a continuous variable. In this case we specifically analyse the relationship between index pair, year and season as a function of the mean temperature per year for each of the months. The results shows a significant difference between each pair of sites within each of the cluster.

```{r}
anova_func <- function(df){
  sites_aov <- aov(temp_mean_month_year ~ index_pair * year * season, data = df)
return(sites_aov)
}

anova_clus_1_func1 <- anova_func(df = SACTN_clust_1_matched)
summary(anova_clus_1_func1)
anova_clus_2_func1 <- anova_func(df = SACTN_clust_2_matched)
summary(anova_clus_2_func1)
anova_clus_3_func1 <- anova_func(df = SACTN_clust_3_matched)
summary(anova_clus_3_func1)
anova_clus_4_func1 <- anova_func(df = SACTN_clust_4_matched)
summary(anova_clus_4_func1)
```

### Monthly comparisons

On a monthly basis, differences of average temperatures between sites within cluster 1 (Cape Agulhas, Gansbaai, Mosterts Hoek, and Ystervarkpunt) varied on an apparent seasonal basis. During the summer months we saw that there were large differences in average temperatures between Gansbaai and the remaining three sites, and between Mosterts hoek and Cape Aghulus. Towards the end of summer and autumn months, in addition to the continuing trends observed between Gansbaai and the remaining sites, we then also saw differences in average temperatures between Cape Agulhas and Mosterts Hoek, and Ystervarkpunt respectively. During winter we see very little differences in average temperatures between all four sites, and this remained relatively stable over the time period. During spring months there were differences between average temperatures of Cape Agulhas and Gansbaai which continues into summer.

Converse to the first cluster, in the cluster containing Kalk Bay, Gordons Bay, Muizenberg and Hermanus, the largest differences in average temperatures were observed during autumn and winter months. In this cluster we saw large differences in average temperatures between Muizenberg and the remaining sites, with the differences increasing annually throughout 1972 and 2016 during winter. Similarly, differences of average temperatures also increased between Kalk Bay and Muizenberg during these same months. In the summer and spring months we saw relatively little differences in average temperatures between sites, with minimal differences in the rates of these changes over the 44 year time period. These rates increased during spring.

In the cluster comprised of Bordjies, Lamberts Bay, Betty's Bay,and Port Nolloth, we found large differences in average temperatures between sites at selected months between 2000 and 2016. During summer months, differences in average temperature between Lamberts Bay and the remaining sites increased throughout the 16 year time period. There were large increases in differences of average temperature between Port Nolloth and Bettys Bay throughout spring months. For the remaining sites, differences in average temperatures were relatively low throughout each month for the same time period.

In the fourth cluster, which was comprised of Antsey's Beach, Glenmore, Port Edward, and Richards Bay, we found small changes in the differences of average temperatures between sites on a monthly basis between 1980 and 2016. Here, the biggest differences in temperatures were observed towards the end of spring and during summer months where we found large differences in average temperatures occurring between Port Edward and the remaining three sites. Some differences were also seen during the autumn months but temperatures were relatively stable throughout the remaining seasons across these four sites.  

Now I make a visualisation to reveal the relationship between the sd of the temperatures for each month of each year for each of the sites in the clusters. This further shows changes in temperature between sites within the same clusters.

```{r define_fun5, include=False}
clust_plot3 <- function(df){
  plot3 <- df %>%
    ggplot(aes(x = year, y = temp_sd_month_year)) +
  geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7) +
  geom_smooth(method = "gam", se = F, aes(colour = index_pair))  +
  facet_wrap(~month) +
  theme_pubclean()
  return(plot3)
}
```

```{r run_fun, include = True, fig.cap = "fig.cap = "Line graph representing the standard deviation of the monthly temperatures (° Celsius). Each graphic shows a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot3 <- clust_plot3(df = SACTN_clust_1_matched)
# SACTN_clust_1_plot3
SACTN_clust_2_plot3 <- clust_plot3(df = SACTN_clust_2_matched)
# SACTN_clust_2_plot3
SACTN_clust_3_plot3 <- clust_plot3(df = SACTN_clust_3_matched)
# SACTN_clust_3_plot3
SACTN_clust_4_plot3 <- clust_plot3(df = SACTN_clust_4_matched)
# SACTN_clust_4_plot3

plot3_final <- ggarrange(SACTN_clust_1_plot3,SACTN_clust_2_plot3,SACTN_clust_3_plot3,SACTN_clust_4_plot3)
plot3_final
```

To further show changes in temperatures between sites within clusters we also assessed the standard deviations of the temperature differences. In the cluster consisting of Cape Aghulus, Gansbaai, Mosterts Hoek, and Ystervarkpunt, we found relatively little differences in changes to standard deviation. The most variation occurred towards the end of the summer season within the months of February, March, and April. The changes in standard deviations of average temperatures were mostly seen between Gansbaai and Cape Aghulus, and between Cape Aghulus and Mosterts Hoek where the rates of temperature fluctuations differed significantly. Throughout the reaming months, standard deviations of temperatures were relatively similar and did not vary much across all sites.

We found similar trends within the cluster containing Gordons Bay, Kalk Bay, Muizenberg, and Hermanus. Here, again we found that there were very little changes in differences between standard deviations of temperatures between sites within most months except those towards the end of summer and autumn seasons. Most variation was found within the months of February, March, and April, and mostly occurred between Gordons Bay and Hermannus. Most sites had very straight linear model lines during the winter season and did not have any apparent significant differences in standard deviations of temperatures across their overlapping time period.

In the cluster containing Lamberts Bay, Bordjies, Betty’s Bay, and Port Nolloth, the biggest shifts in standard deviations of temperature between sites were most prominent during summer. Here, changes in differences of standard deviations fluctuated greatly in November, December, Januaury, February and March. Most variation occurred within November, and seemingly occurred across all four sites as seen by the large slopes in the trend lines. Conversely, winter months had relatively little differences between standard deviations of temperatures.

The cluster containing Antsey’s Beach, Glenmore, Port Edward, and Richards Bay had relatively little changes in differences in standard deviations of temperature differences between sites over the overlapping time period. Here, we saw that slight variation occurred within the months of October, November, and December where there were significant changes between Port Edward and Richards Bay, Antsey’s Beach, and Port Edward respectively. Throughout the remaining months there were relatively little changes in differences of standard deviations of temperature differences between sites as most linear models produced straight lines across the overlapping time period.

### Load wave data

Creating a function which allows me to load the wave data:

```{r define_fun4}
load_wave <- function(wave_files) {
  site_name <- sapply(strsplit(as.character(wave_files), "/"), "[[", 3)
  site_info <- sapply(strsplit(as.character(wave_files), "/"), "[[", 4)
  site_info <- sapply(strsplit(site_info, ".txt"), "[[", 1)
  site_info <- strsplit(site_info, "_")
  site_depth <- sapply(site_info, "[[", 1)
  site_num <- sapply(site_info, "[[", 2)
  
  wave <- read_table(wave_files, col_types = c("dddddd"),
                     col_names = c("date", "hs", "tp", "dir", "dirw", "spw")) %>%
    filter(tp != -999) %>%
    mutate(date = as.POSIXct(as.character(date), "%Y%m%d%H%M", tz = "Africa/Johannesburg")) %>%
    mutate(site = site_name,
           num = site_num,
           depth = site_depth) %>%
    select(site, num, depth, everything()) %>% 
    na.omit()
  return(wave)
}
```

Loading the wave data for the sites along the South African coast:

```{r load-wave}
# Wave sites are renamed as necesary to match SACTN site names
betties_bay <- map_dfr(dir("data/wave_data/Betties Bay", 
                           full.names = TRUE, pattern = "*.txt"), load_wave) %>% 
  mutate(site = "Betty's Bay")
bordjies <- map_dfr(dir("data/wave_data/Bordjies", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
gansbaai <- map_dfr(dir("data/wave_data/Gansbaai", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
gordons_bay <- map_dfr(dir("data/wave_data/Gordons Bay", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
hermanus <- map_dfr(dir("data/wave_data/Hermanus", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
kalk_bay <- map_dfr(dir("data/wave_data/Kalk Bay", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
muizenberg <- map_dfr(dir("data/wave_data/Muizenberg", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
lamberts_bay <- map_dfr(dir("data/wave_data/Lamberts Bay", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
port_nolloth <- map_dfr(dir("data/wave_data/Port Nolloth", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
antseys_beach <- map_dfr(dir("data/wave_data/Antsey's Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
glenmore <-  map_dfr(dir("data/wave_data/Glenmore", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
mostertshoek <-  map_dfr(dir("data/wave_data/Mostertshoek", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
port_edward <- map_dfr(dir("data/wave_data/Port Edward", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
richards_bay <- map_dfr(dir("data/wave_data/Richards Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
ystervarkpunt <- map_dfr(dir("data/wave_data/Ystervarkpunt", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
wave_data <- rbind(betties_bay, bordjies, gansbaai, gordons_bay, hermanus, kalk_bay, lamberts_bay, muizenberg, port_nolloth, antseys_beach, glenmore, mostertshoek, port_edward, richards_bay, ystervarkpunt)
rm(betties_bay, bordjies, gansbaai, gordons_bay, hermanus, kalk_bay, lamberts_bay, muizenberg, port_nolloth, antseys_beach, glenmore, mostertshoek, port_edward, richards_bay, ystervarkpunt)
```

Converting the 3-hour resolution wave data into daily data. The funs function, funs(), is used here as it provides a flexible way to generate a named list of functions for input to other functions such as the mean and sd: https://cran.r-project.org/web/packages/circular/circular.pdf (Pg 130) The circular function creates circular objects around the wind and wave direction. The wave and wind direction was collected every three hours and by using the circular function we calcuated the daily mean wave and wind direction. There is a numerically large gap between 360 and 2 where as in degrees its not as large. The circular mean function returns the mean direction of a vector of circular data.

```{r}

test <- circular::circular(wave_data$dir, units = "degrees")
test <- mean(test) 

```

```{r, include=TRUE}
library(circular)

# Need to add direction categories
# CHOOSE(1+ABS(ROUND(A1/22.5,0)),"N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW","N")

wave_daily_dir <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean.circular(circular(dir, units = "degrees")),
            dirw_circ = mean.circular(circular(dirw, units = "degrees"))) #%>% 
  # mutate(dir_head = ,
  #        dirw_head = )

wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = T) %>%
  ungroup() %>%
  left_join(wave_daily_dir)

# The wind rose diagram gives an accurate representation of how wind speed and direction is distributed at a particular location. 
# This is presented in a circular format. The length of each "spoke" around the circle is related to the frequency of time that the wind flows in a particular direction.
# Each concentric circle represents a different frequency, with zero starting at the center and increasing frequencies in the outer circles

test <- wave_daily %>% 
 filter(site == "Port Nolloth")
windrose(x = test$dir_circ, y = test$hs_mean, main = "Port Nolloth\nWave Rose")
windrose(x = test$dirw_circ, y = test$spw_mean, main = "Port Nolloth\nWind Rose")

anom_func <- function(m){
  m1 <- m-mean(m, na.rm = T)
  return(m1)
}

suppressWarnings(wave_daily_anom <- wave_daily %>% 
  group_by(site, num, depth) %>% 
  mutate_at(vars(-c(site:date)), anom_func))
```

Calculating the annual wave data for each of the sites excluding the year 2000:

```{r, include=TRUE}

# ?circular

wave_annually_dir <- wave_data %>%
  mutate(date = lubridate::year(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean(circular(dir, units = "degrees")),
            dirw_circ = mean(circular(dirw, units = "degrees")))

wave_annually <- wave_data %>%
  mutate(date = lubridate::year(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = TRUE) %>%
  ungroup() %>%
  left_join(wave_annually_dir) %>% 
  filter(date != 2000)

suppressWarnings(wave_annually_anom <- wave_annually %>% 
  group_by(site, num, depth) %>% 
  mutate_at(vars(-c(site:date)), anom_func))
```

### Combining waves and temperatures
Notes from meeting (June 13th, 2018)

* Y2K boundary forcing wasnt provided and takes a year to re-run so won't be used.
* Run the relationships on all of the variables against the temperature first.
* Potentially filter out only days during some large presence of some value and then see how all values relate to temperature.
    * This may then provide guidance on what to do next.
* Potentially run the MHW algorithm on the wave data variables.

Splitting the wave data into the different depths; either a depth of 7m or a depth of 15m:

```{r wave-depth-split}
sites_complete_7 <- wave_daily %>%
  filter(depth == "7m")

sites_complete_15 <- wave_daily %>%
  filter(depth == "15m")

sites_complete_7_anom <- wave_daily_anom %>%
  filter(depth == "7m")

sites_complete_15_anom <- wave_daily_anom %>%
  filter(depth == "15m")
```

Splitting the waves up into two different dataframes requires us to write a bit more code, but ultimately makes it easier to read. The function s.window controls how rapidly the seasonal component can change. Small values allow more rapid change. Setting the seasonal window to be infinite is equivalent to forcing the seasonal component to be periodic. The stlplus package for R has a plot_seasonal function that can be used to generate a cycle-subseries plot in order to visually calibrate s.window. 

```{r}
# Create site column from the index column
SACTN_daily_clusters_sub <- SACTN_daily_clusters_sub %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

# Combine the temperature and 7 m depth wave data
SACTN_daily_clusters_7 <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_7, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 15 m depth wave data
SACTN_daily_clusters_15 <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_15, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 7 m depth wave data
SACTN_daily_clusters_7_anom <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_7_anom, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 15 m depth wave data
SACTN_daily_clusters_15_anom <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_15_anom, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)
```



```{r plot-temp-wave-compare}
# Plot for creating faceted line plots looking at comparisons of trends/patterns
# Tester...
# df <- SACTN_daily_clusters_15
temp_wave_compare <- function(df){
  df1 <- df %>% 
    dplyr::mutate(year = year(date), 
                  week = week(date)) %>% 
    dplyr::select(-date) %>% 
    tidyr::gather(key = variable, value = value, 
                  -c(index:src, year, week, length:depth)) %>% 
    na.omit() %>% 
    ungroup() %>% 
    group_by(index, year, week, variable) %>% 
    na.omit() %>% 
    dplyr::summarise(value = mean(value, na.rm = T)) %>% 
    arrange(index, year, week) %>% 
    group_by(index, variable) %>% 
    mutate(index2 = 1:n())
  ggplot(data = df1, aes(x = index2)) +
    geom_line(aes(y = value, colour = variable, group = )) +
    facet_grid(variable~index, scales = "free_y")
}

temp_wave_compare(SACTN_daily_clusters_7)
temp_wave_compare(SACTN_daily_clusters_15)
```

### Comparing wave data between sites in clusters

```{r wave-compare}

```

### Comparing waves and temperatures

With our temperature and wave values paired up we now want to investigate what the relationship between these values may be. In order to do so we will use linear models, as this produces for us the coefficient of determination (R^2). We are going to use __`purrr`__ to do this as it will allow us to compare multiple variables at once: The following example uses purrr to solve a fairly realistic problem: split a data frame into pieces, fit a model to each piece, compute the summary, then extract the R2. The R2 value is a statistical measure of how close the data are to the fitted regression line. The R2 is the percentage of the response variable variation that is explained by a linear model.

```{r compare-fun}
# A function that runs a linear model on each metric of the combined data and get the R^2 value
temp_wave_R2 <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth), -temp) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp_flat) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp_flat ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4))
  return(results)
  }
```


```{r compare}
SACTN_7_R2 <- SACTN_daily_clusters_7 %>% 
  temp_wave_R2()

SACTN_15_R2 <- SACTN_daily_clusters_15 %>% 
  temp_wave_R2()

SACTN_7_R2_anom <- SACTN_daily_clusters_7_anom %>% 
  temp_wave_R2()

SACTN_15_R2_anom <- SACTN_daily_clusters_15_anom %>% 
  temp_wave_R2()
```

As we may see from these results, the R^2 values between temperatures and wave data are rather low. With R^2 = 0.07 the highest value.

###########################################################
The next step
###########################################################
Download AVHRR for the insitu sites
find a matching time series for the insitu sites
Start working with netCDF files

Various packages in R such as ncdf4, ncdf4.helpers are useful tools for working with netCDF files. The ncdf4 package is used to read netCDF files into R. Here i load the standard packages used in R as well as the ncdf4 package to help run the data.

```{r}
library(ncdf4) # library for processing netCDFs
library(data.table) # for fast .csv write function, `fwrite()`
library(tidyverse) # misc. data processing conveniences
library(reshape2) # for making a long data format
library(plyr) # for `llply()`
library(lubridate) # for working with dates
library(stringr) # for working with strings
library(doMC); doMC::registerDoMC(cores = 4) # for multicore spead-ups

```

The next step is to open the netCDF file. This requires the pathway in which the netCDF data is stored. The function nc_open found within the ncdf4 package is used here to open the netCDF file. This function opens the file, but does not read all the data in the file into R. Instead, this function reads into memory some infomation present within this file. By running the name "nc" i am able to view all the metadata within this file. This includes the various variables present within this dataset.

```{r}
# fn <- "/home/amieroh/Documents/AVHRR/Data/20020530140327-NCEI-L3C_GHRSST-SSTskin-AVHRR_Pathfinder-PFV5.3_NOAA16_G_2002150_day-v02.0-fv01.0.nc"
# nc <- nc_open(fn) # This function opens the netCDF file but does not read all the data
# nc 
```

The next step is to create a file path which will function as an output directory.
Now creating a function to read the netCDF files

```{r}
nc.dir <- "/home/amieroh/Documents/spatial/test/netCDF"
csv.dir <- "/home/amieroh/Documents/spatial/test/csv"
```


```{r}
#          1         2
# 1234567890123456789012345
# avhrr-only-v2.19810901.nc

# specify the region as "latmin", "latmax", "lonmin", "lonmax"

coords <- c(-39.5, -25.5, 10.5, 39.5)

ncRead <- function(nc.dir = nc.dir, csv.dir = csv.dir) {
  nc.files <- list.files(path = nc.dir, pattern = "*.nc", full.names = TRUE, include.dirs = TRUE)
  nc.files <- nc.files[1:10]
  strt.date <- str_sub(basename(nc.files[1]), start = 15, end = 22)
  end.date <- str_sub(basename(nc.files[length(nc.files)]), start = 15, end = 22)
  nc.init <- nc_open(nc.files[1])
  LatIdx <- which(nc.init$dim$lat$vals > coords[1] & nc.init$dim$lat$vals < coords[2])
  LonIdx <- which(nc.init$dim$lon$vals > coords[3] & nc.init$dim$lon$vals < coords[4])
  nc_close(nc.init)
  
  # nc.file <- nc.files[1]
  
  ncFun <- function(nc.file = nc.files, csv.dir = csv.dir) {
    nc <- nc_open(nc.file)
    name.stem <- substr(basename(nc.file), 1, 13) # local
    date.stamp <- substr(basename(nc.file), 15, 22)
    sst <- round(ncvar_get(nc,
                           varid = "sst",
                           start = c(LonIdx[1], LatIdx[1], 1, 1),
                           count = c(length(LonIdx), length(LatIdx), 1, 1)),
                 3)
    dimnames(sst) <- list(lon = nc$dim$lon$vals[LonIdx],
                          lat = nc$dim$lat$vals[LatIdx])
    nc_close(nc)
    sst <-
      as.data.frame(melt(sst, value.name = "temp"), row.names = NULL) %>%
      mutate(t = ymd(date.stamp)) %>%
      na.omit()
    fwrite(sst,
           file = paste0(csv.dir, name.stem, "-", strt.date, "-", end.date, ".csv"),
           append = TRUE, col.names = FALSE)
    rm(sst)
  }
  llply(nc.files, ncFun, csv.dir = csv.dir, .parallel = FALSE)
}
```


```{r}
ncRead(nc.dir, csv.dir)
```
















