---
title: "Methods"
author: "Amieroh Abrahams"
date: "7 May 2018"
output:
  word_document:
    toc: yes
  html_document:
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    highlight: default
    number_sections: yes
    theme: paper
    toc: yes
    toc_float: yes
  pdf_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 6
    highlight: zenburn
    latex_engine: xelatex
mainfont: PT Serif
monofont: PT Mono
language: Australian
sansfont: PT Sans
fontsize: 12pt
---

## Methods

### Startup

First I need to find, install and load various packages. These packages will be available on CRAN and can be accessed and installed in the usual way.

```{r prelim_opts, echo=FALSE}
knitr::opts_chunk$set(
  comment = "R>",
  warning = FALSE,
  message = FALSE
)

library(tidyverse)
library(ggpubr)
library(zoo)
library(lubridate)
library(ggrepel)
library(FNN)
library(stringr)
library(circular)
library(broom)
library(ggrepel)
library(purrr)
library(stlplus)
source("functions/earthdist.R") # lies in the folder labeled funtions
source("functions/scale.bar.func.R")
```

### Load SACTN data

Now to get to the data. The first step involves the loading of the site list. The statistical properties of the seawater temperature representing the South African coastline, such as the mean, minimum and maximum temperatures. These values vary among coastal sections due to the influence of the cold Benguala and warm Agulhas currents.

```{r load_files1, include=TRUE}
load("data/site_list_v4.2.RData")
```

### Clustering

Performing the k-means clustering on a data matrix using the `kmeans()` function, which uses multiple random seeds to find a number of clusting solutions; it selects as the final solution the one that has the minimum total within-cluster sum of squared distances. The data contain variables from many sites along the South African coastline, but in the analysis I use only some of them. These variables include the mean, min and max temperature values. This allows me to group sites based on similar temperature variations. 

```{r setup_k-means, include=TRUE}
set.seed(10)
kmeans(site_list[,c(15, 18, 19)], 6)$cluster
clust_columns <- site_list[,c(15, 18:19)]
```

The coastal region is divided into three sections, namely the cold west coast, warm east coast and the subtropical south coast (Schlegel and Smit 2016; Smit et al 2013; Mead et al 2013). The Benguela Marine Province (BMP) is located to the west of Cape Point and is characterized by the movement of cold water from the Southern Ocean moving north. The cold temperate west coast mentioned above is greatly affected by the upwelling caused by offshore winds, generated by the cold Benguela current. Thus the seawater temperatures found around South Africa’s coastline exhibits a large variational range. My plotting functions partition the data into the clusters and colour code each point accordingly so that I am able to see patterns that exist and distictly group the different sites with similar temperatures along the three distinct coasts. The k-means function previously mentioned produced six clusters. Cluster six was selected as this represented the most accurate and distinct site groupings based on this temperature distribution. Showing a distinct east, south and west coast based on the mean, min and max temperature values.

```{r define_fun1, include=TRUE}
clust_i <- function(i) {
  set.seed(10)
  ggplot(data = site_list,
         aes(x = lon, y = lat,
             colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    borders() +
    geom_point() +
    labs(colour = "cluster") +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
    ggtitle(paste0("clust = ", i))
}

```

```{r run_fun1, include=TRUE}
clust_8 <- clust_i(8)
clust_7 <- clust_i(7)
clust_6 <- clust_i(6)
clust_5 <- clust_i(5)
clust_4 <- clust_i(4)
clust_3 <- clust_i(3)

clusters <- ggarrange(clust_8, clust_7, clust_6, clust_5, clust_4, clust_3, common.legend = T)
clusters
```

Load in the data: For creating the map

```{r}
load("data/southern_africa_coast.Rdata")
load("data/africa_coast.RData")
load("data/sa_provinces_new.RData")
load("data/sa_coast.Rdata")
```

Mapping the sixth cluster - To be added into the methods section

```{r}
load("data/southern_africa_coast.Rdata")
load("data/africa_coast.RData")
load("data/sa_provinces_new.RData")
load("data/sa_coast.Rdata")

library(tidyverse)
library(viridis)
library(gridExtra)

clust_i <- function(i) {
  set.seed(10)
ggplot(data = southern_africa_coast, aes(x = long, y = lat)) +
  geom_polygon(aes(group = group), fill = "grey70") +
    borders() +
    geom_point(data = site_list,
         aes(x = lon, y = lat,colour = as.factor(kmeans(clust_columns, i)$cluster))) +
    labs(colour = "cluster")  +
    coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
  annotate("text", label = "INDIAN\nOCEAN", x = 32.00, y = -34.0, size = 3.0, angle = 0, colour = "black") +
  annotate("text", label = "ATLANTIC\nOCEAN", x = 16.00, y = -34.0, size = 3.0, angle = 0, colour = "black") +
  geom_segment(aes(x = 17.2, y = -32.6, xend = 15.2, yend = -29.5),
                arrow = arrow(length = unit(0.3, "cm")), size = 0.1, colour = "black") +
    annotate("text", label = "Benguela", x = 16.0, y = -31.8, size = 3.5, angle = 298, colour = "black") +
    geom_segment(aes(x = 33, y = -29.5, xend = 29.8, yend = -33.0),
                arrow = arrow(length = unit(0.3, "cm")), size = 0.1, colour = "black") +
    annotate("text", label = "Agulhas", x = 31.7, y = -31.7, size = 3.5, angle = 53, colour = "black") +
  # # Improve on the x and y axis labels
  #   scale_x_continuous(breaks = seq(15, 35, 5),
  #                      labels = scales::unit_format("°E", sep = ""),
  #                      position = "top") +
  #   scale_y_continuous(breaks = seq(-35, -30, 5),
  #                      labels = c("35°S", "30°S")) +
  labs(x = NULL, y = NULL) +
    coord_cartesian(xlim = c(10.5, 39.5), ylim = c(-39.5, -25.5), expand = F) +
  scaleBar(lon = 32.0, lat = -38.7, distanceLon = 200, distanceLat = 50, 
           distanceLegend = 90, dist.unit = "km", arrow.length = 100,
           arrow.distance = 130, arrow.North.size = 3) +
  theme_bw() +
    theme(panel.border = element_rect(fill = NA, colour = "black", size = 1),
          axis.text = element_text(colour = "black"),
          axis.ticks = element_line(colour = "black"))
}

clust_6 <- clust_i(8)
clust_6

africa_map <- ggplot(africa_coast, aes(x = lon, y = lat)) + 
  theme_bw() + 
  coord_equal() + 
  geom_polygon(aes(group = group), colour = "black", fill = "grey80") + 
  geom_polygon(data = sa_provinces_new, (aes(group = group))) +
  annotate("text", label = "Africa", x = 16.0, y = 15.0, size = 3) + 
  theme(panel.border = element_rect(colour = "black", size = 0.4), 
        plot.background = element_blank(), 
        axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  coord_map(xlim = c(-20, 53), ylim = c(-36, 38), projection = "mercator") 
africa_map

# png(file="mrdq.png",w=1800,h=1800, res=300)
# grid.newpage()
# v1<-viewport(width = 1, height = 1, x = 0.5, y = 0.5) #plot area for the main map
# v2<-viewport(width = 0.3, height = 0.3, x = 0.86, y = 0.28) #plot area for the inset map
# print(clust_6,vp=v1) 
# print(africa_map,vp=v2)
# dev.off()

# More mapping - http://r-nold.blogspot.com/2014/06/creating-inset-map-with-ggplot2.html

pdf("figures/map_fixed.pdf", width = 8, height = 5, pointsize = 6) # Set PDF dimensions
vp1 <- viewport(x = -0.00, y = 0.05, w = 0.25, h = 0.25, just = c("left", "bottom")) # Africa
vp2 <- viewport(x = 1.0, y = 1.0, w = 1.00, h = 1.00, just = c("right", "top"))  # South Africa
print(clust_6, vp = vp2)
print(africa_map, vp = vp1)
dev.off()
```

It is now necessary to load the daily SACTN temperature dataset. The SACTN dataset comprise of 129 *in situ* coastal seawater temperatures derived from daily measurements over up to 40 years. The SACTN temperature dataset was compiled by measuring coastal temperatures at 129 sites along the coast of South Africa, daily from 1972 until 2017. 

```{r load_files2, include=TRUE}
load("SACTN_data/SACTN_daily_v4.2.RData")
```

Clustering the sites using the k-means results: Creating a cluster index whilst only selecting cluster 6 Working with at least one decade of data for each of the sites along the coast, and excluding time series with temperature data collected deeper than a five metres. This was done to ensure that the wave data accurately matches up with the temperature data. Some of the UTR's used to collected the temperature data were placed at a depth of 18m. The wave data however is recorded at 7m and 15m respectivley. The length, decadal trend and precision of each time series were adjusted in a systematic manner. This forms the core of the analysis. The natural variability occuring between sites of each of the time series, which differs predictabily between the coastlines is affected by the Benguela and Agulhas currents.
  
```{r run_k-means, include=TRUE}
set.seed(10)
site_list$cluster <- as.factor(kmeans(site_list[,c(15, 18:19)], 6)$cluster)

site_list_clusters <- site_list %>% 
  filter(length >= 3650, depth <= 5)

SACTN_daily_clusters <- SACTN_daily_v4.2 %>% 
  left_join(site_list[,c(4, 13, 21)], by = "index") %>% 
  filter(index %in% site_list_clusters$index)
```

### Site selection

With the sites now split into six clusters, the next step is to reduce the number of sites per cluster down to a manageable, but still representative, sub-sample of the whole. This is done primarily for two reasons. The first, simply, is to allow for the comparisons to be more readily interpretable by humans. The second more objective reason is to allow for an equal amount of sampling per cluster. The East coast is much more heavily sampled than the rest and so this imbalance must be addressed. The criteria that must be considered for the sub-samples are that both instrument types (UTR and thermometer) are present, and as many sources are included as are possible. The statistical characteristics of the seawater temperature dataset was used as to guide analyses into the suitability of the time series which allows us to produce an accurate assessment of temperature variation between sites located within the same cluster. The precision, length and decadal trend of the time series for each of the sites were adjusted systematically.

```{r site_sub_samples, include=TRUE}
# First simply divide up the site list by cluster
sites_1 <- site_list_clusters %>%
  filter(cluster == 1)
sites_2 <- site_list_clusters %>%
  filter(cluster == 2)
sites_3 <- site_list_clusters %>%
  filter(cluster == 3)
sites_4 <- site_list_clusters %>%
  filter(cluster == 4)
sites_5 <- site_list_clusters %>%
  filter(cluster == 5)
sites_6 <- site_list_clusters %>%
  filter(cluster == 6)

# I then grouped the sub-samples by source and took the longest time series
# When fewer than 4 sources were present, I took the next longest time series etc.
sites_1_sub <- sites_1 %>%
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  ungroup()

sites_2_sub <- sites_2 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,3))

sites_3_sub <- sites_3 %>%
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,5))

sites_4_sub <- sites_4 %>% 
  group_by(src) %>%
  filter(length %in% head(length, 2)) %>%
  #filter(NA.perc %in% tail(NA.perc, 2)) %>%
  ungroup() %>% 
  slice(c(2,3,4))

sites_5_sub <- sites_5 %>% 
  group_by(src) %>%
  #filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,4,10)) # slicing the 10row of site5.....

sites_6_sub <- sites_6 %>% 
  group_by(src) %>%
  filter(length %in% head(length, 4)) %>% 
  ungroup() %>% 
  slice(c(1,2,3))

# This then creates subsets of the four sites per cluster
# Though we may want to consider the distance between sites as well...
# Anyway, for now I stitch them together to be used as a further index
# for subsetting the daily data

site_list_sub <- rbind(sites_1_sub, sites_2_sub, sites_3_sub, sites_4_sub, sites_5_sub, sites_6_sub)
# write_csv(site_list_sub, path = "data/site_list_sub.csv")
# Then subset the daily data
SACTN_daily_clusters_sub <- SACTN_daily_clusters %>%
  filter(index %in% site_list_sub$index)
```

### Site locations

Map showing the location of each site within each of the six clusters

```{r load_files3, include=TRUE}
load("Mapping/sa_provinces.RData")
load("Mapping/south_africa_coast.RData")
```

```{r define_fun2, include=TRUE}
site_coordinates1 <- filter(site_list_sub, cluster == 1) %>% 
  select(site, lon, lat)

site_coordinates2 <- filter(site_list_sub, cluster == 2) %>% 
  select(site, lon, lat)

site_coordinates3 <- filter(site_list_sub, cluster == 3) %>% 
   select(site, lon, lat)

site_coordinates4 <- filter(site_list_sub, cluster == 4) %>% 
  select(site, lon, lat)

site_coordinates5 <- filter(site_list_sub, cluster == 5) %>% 
  select(site, lon, lat)

site_coordinates6 <- filter(site_list_sub, cluster == 6) %>% 
  select(site, lon, lat)

mapping_plot <- function(df, xy = "salmon"){
  mapping <- df %>% 
ggplot(aes(x = lon, y = lat)) +
  geom_polygon(data = south_africa_coast, aes(group = group), fill = "grey70") +
  coord_cartesian(xlim = c(12, 36), ylim = c(-38, -26)) +
  geom_path(data = sa_provinces, aes(group = group)) +
  geom_point(data = df, colour = xy)  +
  geom_label_repel(data =df, aes(x = lon, y = lat, label = site), 
                   size = 3, box.padding = 2, nudge_x = -0.5, nudge_y = 0.2, 
                   segment.alpha = 0.4, force = 0.1) +
  coord_equal(xlim = c(15, 35), ylim = c(-37, -27)) +
  annotate("text", label = "INDIAN\nOCEAN", x = 35.00, y = -34.0, size = 3.0, angle = 0, colour = "black") +
  annotate("text", label = "ATLANTIC\nOCEAN", x = 12.00, y = -34.0, size = 3.0, angle = 0, colour = "black") +
  # geom_segment(aes(x = 17.2, y = -32.6, xend = 15.2, yend = -29.5),
  #               arrow = arrow(length = unit(0.3, "cm")), size = 0.1, colour = "black") +
  #   annotate("text", label = "Benguela", x = 14.0, y = -31.8, size = 3.5, angle = 298, colour = "black") +
  #   geom_segment(aes(x = 33, y = -29.5, xend = 29.8, yend = -33.0),
  #               arrow = arrow(length = unit(0.3, "cm")), size = 0.1, colour = "black") +
  #   annotate("text", label = "Agulhas", x = 31.7, y = -31.7, size = 3.5, angle = 53, colour = "black") +
  # scale_x_continuous(breaks = seq(15, 35, 5),
  #                      labels = scales::unit_format("°E", sep = ""),
  #                      position = "bottom") +
  #   scale_y_continuous(breaks = seq(-35, -30, 5),
  #                      labels = c("35°S", "30°S")) +
    labs(x = NULL, y = NULL) +
    coord_cartesian(xlim = c(10.5, 39.5), ylim = c(-39.5, -25.5), expand = F) +
     scaleBar(lon = 32.0, lat = -38.7, distanceLon = 200, distanceLat = 50, 
           distanceLegend = 90, dist.unit = "km", arrow.length = 100,
           arrow.distance = 130, arrow.North.size = 3) +
  theme_bw() +
    theme(panel.border = element_rect(fill = NA, colour = "black", size = 1),
          axis.text = element_text(colour = "black"),
          axis.ticks = element_line(colour = "black"))
  return(mapping)
}
```

```{r run_fun2, include=TRUE}
map_clus1 <- mapping_plot(df = site_coordinates1, xy = "salmon")
map_clus2 <- mapping_plot(df = site_coordinates2, xy = "darkgoldenrod4")
map_clus3 <- mapping_plot(df = site_coordinates3, xy = "springgreen4")
map_clus4 <- mapping_plot(df = site_coordinates4, xy= "lightskyblue")
map_clus5 <- mapping_plot(df = site_coordinates5, xy= "steelblue3") 
map_clus6 <- mapping_plot(df = site_coordinates6, xy= "mediumorchid1") 

final_map_combined_A <- ggarrange(map_clus1, map_clus2, map_clus3, map_clus4, map_clus5, map_clus6)
final_map_combined_A

# pdf("figures/final_map_combined_A_new.pdf", width = 8, height = 5, pointsize = 6) # Set PDF dimensions

ggsave(plot = final_map_combined_A, filename = "figures/final_combined_plot.pdf")

```

The function droplevels is used here to drop unused levels from the factor such as the length column. The unique function is then used to determine the amount sites found within this cluster:

```{r, include=TRUE}
# SACTN_clust_1 <- SACTN_daily_clusters %>%
#   filter(cluster == 1) %>%
#   select(-length) %>%
#   droplevels()
# length(unique(SACTN_clust_1$index))
```

## Calculating the distance between sites

Calculating the distance between each of the sites along the coastline. The deg2rad function transforms degrees to radians: Transforms between angles in degrees and radians. 

```{r calc-dists}
options(scipen=999) # Forces R to not use exponential notation
sa_coast_prep <- sa_coast %>% 
  mutate(site = 1:nrow(.),
         X = deg2rad(X),
         Y = deg2rad(Y)) %>% 
  select(site, X, Y)

sa_coast_dist <- as.data.frame(round(PairsDists(sa_coast_prep), 2)) %>% 
  mutate(lon = sa_coast$X,
         lat = sa_coast$Y) %>% 
  dplyr::rename(dist = V1) %>%
  select(lon, lat, dist) %>% 
  mutate(cum_dist = cumsum(dist)) %>% 
  mutate(dist = lag(dist),
         cum_dist = lag(cum_dist))
```

### Matching sites

Creating a function to match the sites with in a cluster: This function allows me to match sites within the same cluster based on the date that temperature was collected. This allows me to compare whether or not a temperature variation exist between sites within the same cluster and to examine various reasons for this variation. Here we consider distance between sites.

```{r define_fun3, include=TRUE}
## testing...
# df <- SACTN_daily_clusters
# clust <- 1
##
clust_match <- function(df, clust) {
  SACTN_clust_x_match <- data.frame()
  df2 <- df %>%
    filter(cluster == clust) %>%
    select(-length) %>%
    droplevels()
  for (i in 1:length(levels(df2$index))) {  
    # for (i in 1:10) {
    SACTN_df_1 <- filter(df2, index == levels(index)[i])
    
    # Find the cumulative distance of site 1 along the coast
    site_dist_1 <- site_list_clusters %>% 
      filter(index == as.character(SACTN_df_1$index)[1])
    site_dist_1 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                              query = as.matrix(site_dist_1[,5:6]), k = 1)
    site_dist_1 <- sa_coast_dist$cum_dist[site_dist_1]
    
    for (j in 1:length(levels(df2$index))) {
      # for(j in 1:10) {
      if (i == j) {
        next
      }
      if (j < i) {
        next
      }
      SACTN_df_2 <- filter(df2, index == levels(index)[j])
      
      # Find the cumulative distance of site 2 along the coast
      site_dist_2 <- site_list_clusters %>% 
        filter(index == as.character(SACTN_df_2$index)[1])
      site_dist_2 <- knnx.index(data = as.matrix(sa_coast_dist[,1:2]),
                                query = as.matrix(site_dist_2[,5:6]), k = 1)
      site_dist_2 <- sa_coast_dist$cum_dist[site_dist_2]
      
      # The distance between the two sites
      site_dist_3 <- round(abs(site_dist_1-site_dist_2), 0)
      
      SACTN_df_3 <- left_join(SACTN_df_1, SACTN_df_2, by = "date") %>%
        na.trim() %>%
        select(date, index.x, temp.x, index.y, temp.y, -cluster.x, -cluster.y) %>%
        dplyr::rename(index_1 = index.x,
          temp_1 = temp.x,
          index_2 = index.y,
          temp_2 = temp.y) %>%
        mutate(index_pair = paste0(index_1, " - ", index_2, " - ", site_dist_3),
               index_dist = site_dist_3)
      SACTN_clust_x_match <- rbind(SACTN_clust_x_match, SACTN_df_3)
    }
  }
  return(SACTN_clust_x_match)
}
```

Creating a function which allows me to calculated the monthly mean temperature and standard deviation for each year and sites. Consequently we have a data frame with 7 columns and each of the rows representing each month for each of the years. By calculating the mean and SD for each site i am able identify trends in their temperatures and to compare these trends across sites within the same cluster. Mean and SD gives a broad look of the overall temperature for each of the sites. With each group of months representing the season.

```{r run_fun3, include=TRUE}
# Calculate all of the matche-ups in cluster 1
SACTN_clust_1_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 1)
SACTN_clust_2_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 2)
SACTN_clust_3_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 3)
SACTN_clust_4_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 4)
SACTN_clust_5_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 5)
SACTN_clust_6_match <- clust_match(df = SACTN_daily_clusters_sub, clust = 6)

clust_matched <- function(df) {
  SACTN_clust_x_matched <- df %>%
  mutate(temp_matched = temp_1-temp_2,
         month = month(date, abbr = T, label = T),
         year = year(date)) %>%
  select(-temp_1, -temp_2) %>%
  group_by(index_pair, index_dist, month, year) %>%
  summarise(temp_mean_month_year = mean(temp_matched, na.rm = T),
            temp_sd_month_year = sd(temp_matched, na.rm = T)) %>% 
    mutate(season = ifelse(month %in% c("Jan", "Feb", "Mar"), "Summer",        
                           ifelse(month %in% c("Apr", "May", "Jun"), "Autumn",
                                ifelse(month %in% c("Jul", "Aug", "Sep"), "Winter",
                                       ifelse(month %in% c("Oct", "Nov", "Dec"), "Spring","Error")))))
  return(SACTN_clust_x_matched)
}

SACTN_clust_1_matched <- clust_matched(df = SACTN_clust_1_match)
SACTN_clust_2_matched <- clust_matched(df = SACTN_clust_2_match)
SACTN_clust_3_matched <- clust_matched(df = SACTN_clust_3_match)
SACTN_clust_4_matched <- clust_matched(df = SACTN_clust_4_match)
SACTN_clust_5_matched <- clust_matched(df = SACTN_clust_5_match)
SACTN_clust_6_matched <- clust_matched(df = SACTN_clust_6_match)
```

#### ANOVA

Anova analysis: This allows me to compare one variable in two or more groups taking into account the variability of other variables. This analysis of covariance is used to test the main effect of variables on a continuous variable. In this case we specifically analyse the 
- Relationship between index pair, year and season as a function of the mean temperature per year for each of the months. 
- The results shows a significant difference between each pair of sites within each of the cluster.

```{r define_fun6, include=TRUE}
anova_func <- function(df){
  sites_aov <- aov(temp_mean_month_year ~ index_pair * year * season, data = df)
return(sites_aov)
}
```

```{r run_fun6, include=TRUE}
anova_clus_1_func1 <- anova_func(df = SACTN_clust_1_matched)
summary(anova_clus_1_func1)
anova_clus_2_func1 <- anova_func(df = SACTN_clust_2_matched)
summary(anova_clus_2_func1)
anova_clus_3_func1 <- anova_func(df = SACTN_clust_3_matched)
summary(anova_clus_3_func1)
anova_clus_4_func1 <- anova_func(df = SACTN_clust_4_matched)
summary(anova_clus_4_func1)
anova_clus_5_func1 <- anova_func(df = SACTN_clust_5_matched)
summary(anova_clus_5_func1)
anova_clus_6_func1 <- anova_func(df = SACTN_clust_6_matched)
summary(anova_clus_6_func1)
```

### Comparing sites

The code below lets us visualise the temperatures for each of the sites.  This box plot allows me to observe whether or not a variation exist between the sites found within the same cluster. The values represent the distance "km" between the sites Temperature 1 represents a site and temperature 2 represents a second site. The boxplot shows the temperature variation of two sites within the same cluster (along the same coast) being compared to eachother. To conclude, temperatures were not uniformly distributed with each set of sites having a unique temperature variation. 

```{r define_fun4, include=TRUE}
clust_plot <- function(df) {
  plot1 <- df %>%
    select(-index_1, -index_2) %>% 
    gather(key = "temp_grp", val = "temp", -date, -index_pair, - index_dist) %>% 
    ggplot(aes(x = index_pair)) +
    geom_boxplot(aes(y = temp, fill = temp_grp), alpha = 0.3) +
    scale_fill_manual(values = c("khaki4", "chartreuse3")) +
    labs(x = "Paired Sites", y = "Temperature °C") +
    theme(legend.position="none") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
      return(plot1)
}
```

```{r run_fun4,  fig.cap = "Boxplots representing the different site locations along the South African coast represented by various temperature parameters. Temperature parameters include minimum, maximum and mean temperatures (°C). The Boxplots represent the minimum, 25th percentile, median and 75th percentile of the temperatures measured. The interquartile can be dedudced by the difference between the percentiles with the dots representing the outliers in the data.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot1 <- clust_plot(df = SACTN_clust_1_match)
SACTN_clust_2_plot1 <- clust_plot(df = SACTN_clust_2_match)
SACTN_clust_3_plot1 <- clust_plot(df = SACTN_clust_3_match)
SACTN_clust_4_plot1 <- clust_plot(df = SACTN_clust_4_match)
SACTN_clust_5_plot1 <- clust_plot(df = SACTN_clust_5_match)
SACTN_clust_6_plot1 <- clust_plot(df = SACTN_clust_6_match)

combined_plot <- ggarrange(SACTN_clust_1_plot1, SACTN_clust_2_plot1,
                           SACTN_clust_3_plot1, SACTN_clust_4_plot1, 
                           SACTN_clust_5_plot1, SACTN_clust_6_plot1)
combined_plot

ggsave(plot = combined_plot, filename = "figures/combined_plot.pdf")
ggsave(plot = combined_plot, filename = "figures/combined_plot_1.png")
```

Temperatures were not uniformly distributed across our four clusters produced, with each set of sites having unique patterns of temperature variation. In cluster 1, which includes Humburg, Eastern  Beach and Orient Beach, we found that temperature varied from approximately 13 ºC to 22  ºC. Within this cluster of sites, we found that Hamburg had the highest maximum temperatures and the lowest minimum temperatures between the three sites. Orient  Beach had the lowest range of temperature variability and it produced a comparatively short box plot. Orient Beach and Eastern Beach had relatively similar ranges and distributions of temperatures as evident by their bixplots nearly overlapping completely. 

In the cluster comprising of Mossel Bay, Stilbaai and Knysna, temperatures ranged from approximately 12 ºC to 27  ºC, with most box plots being relatively long. Stilbaai had the widest range of temperature variation of the three sites. Despite the apparent differences in temperature ranges between these sites, the average temperatures across these were relatively similar and near completely identical, with very few outliers present within the temperatures of these sites.

Sites within the third cluster had slightly lower temperatures than the previous two clusters. This cluster comprise of Bordjies, Saldanha and Gansbaai, Temperatures within this cluster ranged from approximately 11 ºC to 21  ºC, with an average median temperature being close to 15  ºC across all three of the sites. Gansbaai had relatively low variation in temperature as it had a comparatively short box plot. Conversely, Saldanha had relatively long box plots representing high variation and relatively evenly distributed temperatures. These sites were relatively similar in terms of temperature variances, as their box plots were largely overlapping with few differences between them. There were however several outliers present within the temperatures of these sites.
The fourth cluster comprised of Port Edward, Leisure Baay and T.O. Strand. Overall, the temperatures of these sites were higher than those of the sites within the other clusters, with a range of between 15 ºC  to 25 ºC, which is considerably much higher than that of the others.  The box plots were all relatively long representing a low variation, and had very little skewness. Temperature did not differ between these three sites with each box plot overlapping very well. The median temperature for each of the sites within this cluster is 20.5  ºC. 

Sites within the fifth cluster had overall lower temperatures than those within the remaining clusters. This cluster comprised of Port Nolloth, Lamberts Bay and Sea Point, and here we found sharp declines in average temperatures throughout. The temperature range within this cluster was approximately 8 ºC to 18 ºC, with an average median temperature being close to 13 ºC. Port Nolloth had relatively low variation in temperature as it had a comparatively short box plot with relatively evenly distributed temperatures. Lamberts Bay and Sea Point were relatively similar in terms of temperature variances, as their box plots were largely overlapping with little differences between them. Several outliers are present within the temperatures of these sites.

In the cluster comprising of Kalk Bay, Muizenberg and Gordons Bay temperature ranged from  approximately 8 ºC to 24  ºC, with most box plots being relativley short. Muizenberg had the widest range of temperature variation of the three sites.  Gordons Bay and Kalk Bay, had identical temperature ranges. Despite the apparent differences in temperature ranges between these sites, the average temperatures across these were relatively similar and near completely identical.

### Comparing time series

Now I create a visualisation to reveal the relationship between the mean temperature for each month of each year over time for each of the sites in cluster: This allows me to assess whether or not an average temperature differences exist between sites on a seasonal basis and to examine the intensity of this variation over the past years. It clearly indictaes that temperature differences exist between sites on a seasonal basis and that some sites warmed at a much greater rate when compared to others.

```{r define_fun5, include=TRUE}
clust_plot2 <- function(df){
  plot2 <- df %>%
    ggplot(aes(x = year, y = temp_mean_month_year)) +
    geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7, show.legend = F) +
    geom_smooth(method = "gam", se = F, aes(colour = index_pair), show.legend = T)  +
    labs(x = "Year", y = "Average temperature °C") +
    facet_wrap(~month) +
    theme_bw()
  return(plot2)
}
```

```{r run_fun5, fig.cap = "Line graphs representing the monthly average temperatures between two sites (° Celsius). Each graphic showing a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided. The linear lines are the linear models in their respective colours ", fig.height = 8, fig.width = 12}
(SACTN_clust_1_plot2 <- clust_plot2(df = SACTN_clust_1_matched))
(SACTN_clust_2_plot2 <- clust_plot2(df = SACTN_clust_2_matched))
(SACTN_clust_3_plot2 <- clust_plot2(df = SACTN_clust_3_matched))
(SACTN_clust_4_plot2 <- clust_plot2(df = SACTN_clust_4_matched))
(SACTN_clust_5_plot2 <- clust_plot2(df = SACTN_clust_5_matched))
(SACTN_clust_6_plot2 <- clust_plot2(df = SACTN_clust_6_matched))

ggsave(plot = SACTN_clust_1_plot2, filename = "figures/SACTN_clust_1_plot2.pdf")
ggsave(plot = SACTN_clust_2_plot2, filename = "figures/SACTN_clust_2_plot2.pdf")
ggsave(plot = SACTN_clust_3_plot2, filename = "figures/SACTN_clust_3_plot2.pdf")
ggsave(plot = SACTN_clust_4_plot2, filename = "figures/SACTN_clust_4_plot2.pdf")
ggsave(plot = SACTN_clust_5_plot2, filename = "figures/SACTN_clust_5_plot2.pdf")
ggsave(plot = SACTN_clust_6_plot2, filename = "figures/SACTN_clust_6_plot2.pdf")
```

### Monthly comparisons

On a monthly basis, differences of average temperatures between sites within cluster 1 (Cape Agulhas, Gansbaai, Mosterts Hoek, and Ystervarkpunt) varied on an apparent seasonal basis. During the summer months we saw that there were large differences in average temperatures between Gansbaai and the remaining three sites, and between Mosterts hoek and Cape Aghulus. Towards the end of summer and autumn months, in addition to the continuing trends observed between Gansbaai and the remaining sites, we then also saw differences in average temperatures between Cape Agulhas and Mosterts Hoek, and Ystervarkpunt respectively. During winter we see very little differences in average temperatures between all four sites, and this remained relatively stable over the time period. During spring months there were differences between average temperatures of Cape Agulhas and Gansbaai which continues into summer.

Converse to the first cluster, in the cluster containing Kalk Bay, Gordons Bay, Muizenberg and Hermanus, the largest differences in average temperatures were observed during autumn and winter months. In this cluster we saw large differences in average temperatures between Muizenberg and the remaining sites, with the differences increasing annually throughout 1972 and 2016 during winter. Similarly, differences of average temperatures also increased between Kalk Bay and Muizenberg during these same months. In the summer and spring months we saw relatively little differences in average temperatures between sites, with minimal differences in the rates of these changes over the 44 year time period. These rates increased during spring.

In the cluster comprised of Bordjies, Lamberts Bay, Betty's Bay,and Port Nolloth, we found large differences in average temperatures between sites at selected months between 2000 and 2016. During summer months, differences in average temperature between Lamberts Bay and the remaining sites increased throughout the 16 year time period. There were large increases in differences of average temperature between Port Nolloth and Bettys Bay throughout spring months. For the remaining sites, differences in average temperatures were relatively low throughout each month for the same time period.

In the fourth cluster, which was comprised of Antsey's Beach, Glenmore, Port Edward, and Richards Bay, we found small changes in the differences of average temperatures between sites on a monthly basis between 1980 and 2016. Here, the biggest differences in temperatures were observed towards the end of spring and during summer months where we found large differences in average temperatures occurring between Port Edward and the remaining three sites. Some differences were also seen during the autumn months but temperatures were relatively stable throughout the remaining seasons across these four sites.  

Now I make a visualisation to reveal the relationship between the sd of the temperatures for each month of each year for each of the sites in the clusters. This further shows changes in temperature between sites within the same clusters.

```{r define_fun7, include=TRUE}
clust_plot3 <- function(df){
  plot3 <- df %>%
    ggplot(aes(x = year, y = temp_sd_month_year)) +
  geom_line(aes(group = index_pair, colour = index_pair), alpha = 0.7) +
  geom_smooth(method = "gam", se = F, aes(colour = index_pair))  +
  facet_wrap(~month) +
  theme_pubclean()
  return(plot3)
}
```

```{r run_fun7, include = TRUE, fig.cap = "fig.cap = "Line graph representing the standard deviation of the monthly temperatures (° Celsius). Each graphic shows a different month overtime from 1990 to 2016. These site locations are coloured by the temperature statistic relative to the legends provided.", fig.height = 8, fig.width = 12}
SACTN_clust_1_plot3 <- clust_plot3(df = SACTN_clust_1_matched)
# SACTN_clust_1_plot3
SACTN_clust_2_plot3 <- clust_plot3(df = SACTN_clust_2_matched)
# SACTN_clust_2_plot3
SACTN_clust_3_plot3 <- clust_plot3(df = SACTN_clust_3_matched)
# SACTN_clust_3_plot3
SACTN_clust_4_plot3 <- clust_plot3(df = SACTN_clust_4_matched)
# SACTN_clust_4_plot3
SACTN_clust_5_plot3 <- clust_plot3(df = SACTN_clust_5_matched)
SACTN_clust_6_plot3 <- clust_plot3(df = SACTN_clust_6_matched)


plot3_final <- ggarrange(SACTN_clust_1_plot3,SACTN_clust_2_plot3,
                         SACTN_clust_3_plot3,SACTN_clust_4_plot3,
                         SACTN_clust_5_plot3, SACTN_clust_6_plot3)
plot3_final
```

To further show changes in temperatures between sites within clusters we also assessed the standard deviations of the temperature differences. In the cluster consisting of Cape Aghulus, Gansbaai, Mosterts Hoek, and Ystervarkpunt, we found relatively little differences in changes to standard deviation. The most variation occurred towards the end of the summer season within the months of February, March, and April. The changes in standard deviations of average temperatures were mostly seen between Gansbaai and Cape Aghulus, and between Cape Aghulus and Mosterts Hoek where the rates of temperature fluctuations differed significantly. Throughout the reaming months, standard deviations of temperatures were relatively similar and did not vary much across all sites.

We found similar trends within the cluster containing Gordons Bay, Kalk Bay, Muizenberg, and Hermanus. Here, again we found that there were very little changes in differences between standard deviations of temperatures between sites within most months except those towards the end of summer and autumn seasons. Most variation was found within the months of February, March, and April, and mostly occurred between Gordons Bay and Hermannus. Most sites had very straight linear model lines during the winter season and did not have any apparent significant differences in standard deviations of temperatures across their overlapping time period.

In the cluster containing Lamberts Bay, Bordjies, Betty’s Bay, and Port Nolloth, the biggest shifts in standard deviations of temperature between sites were most prominent during summer. Here, changes in differences of standard deviations fluctuated greatly in November, December, Januaury, February and March. Most variation occurred within November, and seemingly occurred across all four sites as seen by the large slopes in the trend lines. Conversely, winter months had relatively little differences between standard deviations of temperatures.

The cluster containing Antsey’s Beach, Glenmore, Port Edward, and Richards Bay had relatively little changes in differences in standard deviations of temperature differences between sites over the overlapping time period. Here, we saw that slight variation occurred within the months of October, November, and December where there were significant changes between Port Edward and Richards Bay, Antsey’s Beach, and Port Edward respectively. Throughout the remaining months there were relatively little changes in differences of standard deviations of temperature differences between sites as most linear models produced straight lines across the overlapping time period.

### Load wave data

Creating a function which allows me to load the wave data:

```{r define_fun8, include=TRUE}
load_wave <- function(wave_files) {
  site_name <- sapply(strsplit(as.character(wave_files), "/"), "[[", 3)
  site_info <- sapply(strsplit(as.character(wave_files), "/"), "[[", 4)
  site_info <- sapply(strsplit(site_info, ".txt"), "[[", 1)
  site_info <- strsplit(site_info, "_")
  site_depth <- sapply(site_info, "[[", 1)
  site_num <- sapply(site_info, "[[", 2)
  
  wave <- read_table(wave_files, col_types = c("dddddd"),
                     col_names = c("date", "hs", "tp", "dir", "dirw", "spw")) %>%
    filter(tp != -999) %>%
    mutate(date = as.POSIXct(as.character(date), "%Y%m%d%H%M", tz = "Africa/Johannesburg")) %>%
    mutate(site = site_name,
           num = site_num,
           depth = site_depth) %>%
    select(site, num, depth, everything()) %>% 
    na.omit()
  return(wave)
}
```

Loading the wave data for the sites along the South African coast:

```{r run_fun8 load_files3, include = TRUE}
# Wave sites are renamed as necesary to match SACTN site names
betties_bay <- map_dfr(dir("data/wave_data/Betties Bay", 
                           full.names = TRUE, pattern = "*.txt"), load_wave) %>% 
  mutate(site = "Betty's Bay")
bordjies <- map_dfr(dir("data/wave_data/Bordjies", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
gansbaai <- map_dfr(dir("data/wave_data/Gansbaai", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
gordons_bay <- map_dfr(dir("data/wave_data/Gordons Bay", 
                           full.names = TRUE, pattern = "*.txt"), load_wave)
hermanus <- map_dfr(dir("data/wave_data/Hermanus", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
kalk_bay <- map_dfr(dir("data/wave_data/Kalk Bay", 
                        full.names = TRUE, pattern = "*.txt"), load_wave)
muizenberg <- map_dfr(dir("data/wave_data/Muizenberg", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
lamberts_bay <- map_dfr(dir("data/wave_data/Lamberts Bay", 
                          full.names = TRUE, pattern = "*.txt"), load_wave)
port_nolloth <- map_dfr(dir("data/wave_data/Port Nolloth", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
antseys_beach <- map_dfr(dir("data/wave_data/Antsey's Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
glenmore <-  map_dfr(dir("data/wave_data/Glenmore", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
mostertshoek <-  map_dfr(dir("data/wave_data/Mostertshoek", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
port_edward <- map_dfr(dir("data/wave_data/Port Edward", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
richards_bay <- map_dfr(dir("data/wave_data/Richards Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)
ystervarkpunt <- map_dfr(dir("data/wave_data/Ystervarkpunt", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

eastern_beach <- map_dfr(dir("data/wave_data/Eastern Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

hamburg <- map_dfr(dir("data/wave_data/Hamburg", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

orient_beach <- map_dfr(dir("data/wave_data/Orient Beach", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

stilbaai <- map_dfr(dir("data/wave_data/Stilbaai", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

mossel_bay <- map_dfr(dir("data/wave_data/Mossel Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

knysna <- map_dfr(dir("data/wave_data/Knysna", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

port_edward <- map_dfr(dir("data/wave_data/Port Edward", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

to_strand <- map_dfr(dir("data/wave_data/T.O. Strand", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

leisure_bay <- map_dfr(dir("data/wave_data/Leisure Bay", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

sea_point <- map_dfr(dir("data/wave_data/Sea Point", 
                            full.names = TRUE, pattern = "*.txt"), load_wave)

wave_data <- rbind(betties_bay, bordjies, gansbaai, gordons_bay, hermanus, kalk_bay, lamberts_bay, muizenberg, port_nolloth, antseys_beach, glenmore, mostertshoek, port_edward, richards_bay, ystervarkpunt, eastern_beach, hamburg, orient_beach, stilbaai, mossel_bay, knysna, to_strand, leisure_bay, sea_point)

rm(betties_bay, bordjies, gansbaai, gordons_bay, hermanus, kalk_bay, lamberts_bay, muizenberg, port_nolloth, antseys_beach, glenmore, mostertshoek, port_edward, richards_bay, ystervarkpunt, eastern_beach, hamburg, orient_beach, stilbaai, mossel_bay, knysna, to_strand, leisure_bay, sea_point)
```

Converting the 3-hour resolution wave data into daily data. https://cran.r-project.org/web/packages/circular/circular.pdf (Pg 130). The circular function creates circular objects around the wind and wave direction. The wave and wind direction was collected every three hours and by using the circular function we calcuated the daily mean wave and wind direction. There is a numerically large gap between 360 and 2 where as in degrees its not as large. The circular mean function returns the mean direction of a vector of circular data.

```{r}
# test <- circular::circular(wave_data$dir, units = "degrees")
# test <- mean(test) 
# Need to add direction categories
# CHOOSE(1+ABS(ROUND(A1/22.5,0)),"N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW","N")

wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean.circular(circular(dir, units = "degrees")),
            dirw_circ = mean.circular(circular(dirw, units = "degrees")),
            spw_circ = mean.circular(circular(spw, units = "degrees")),
            hs_circ = mean.circular(circular(hs, units = "degrees")),
            tp_circ = mean.circular(circular(tp, units = "degrees"))) #%>% 
  # mutate(dir_head = ,
  #        dirw_head = )
```

Here we are splitting the daily wave data into depths of 7m and 15m respectivley

```{r}
sites_complete_7a <- wave_daily %>%
  filter(depth == "7m")

sites_complete_15a <- wave_daily %>%
  filter(depth == "15m")
```

Now i match the SACTN seawater temperature data with the wave data

```{r}
SACTN_daily_clusters_sub_1 <- SACTN_daily_clusters_sub %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

try1 <- function(df) {
  func1 <- df %>% 
    left_join(sites_complete_7a, by = c("site", "date")) %>% 
    na.trim() %>% 
    group_by(site)
    return(func1)
}
try2 <- function(df) {
  func2 <- df %>% 
    left_join(sites_complete_15a, by = c("site", "date")) %>% 
    na.trim() %>% 
    group_by(site)
    return(func2)
}

SACTN_daily_clusters_7a <- try1(df = SACTN_daily_clusters_sub_1)
SACTN_daily_clusters_15a <- try2(df = SACTN_daily_clusters_sub_1)
```

Creating scatter plot where I compare wave dir,dirw,spw for the insitu datasets

```{r}
# plot_compare_spw <- function(df) {
#   plot_temp_wave <- df %>% 
#     ggplot(aes(x = temp, y = spw_circ )) +
# plot_compare_tp<- function(df) {
#   plot_temp_wave <- df %>% 
#     ggplot(aes(x = temp, y = tp_circ )) +
#     geom_point() +
#   facet_wrap(~site, scales = "free_x", ncol = 2) +
#   # labs(x = "Year", y = "Null") +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_line(color = "#cfcfcf", size = 0.4))
#   return(plot_temp_wave)
# }
# 
# plot_compare_dir<- function(df) {
#   plot_temp_wave <- df %>% 
#     ggplot(aes(x = temp, y = dir_circ )) +
#     geom_point() +
#   facet_wrap(~site, scales = "free_x", ncol = 2) +
#   # labs(x = "Year", y = "Null") +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_line(color = "#cfcfcf", size = 0.4))
#   return(plot_temp_wave)
# }
# 
# plot_compare_dirw<- function(df) {
#   plot_temp_wave <- df %>% 
#     ggplot(aes(x = temp, y = dirw_circ )) +
#     geom_point() +
#   facet_wrap(~site, scales = "free_x", ncol = 2) +
#   # labs(x = "Year", y = "Null") +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_line(color = "#cfcfcf", size = 0.4))
#   return(plot_temp_wave)
# }
# 
# # For insitu data
# Insitu_spw_circ <- plot_compare_spw(df = SACTN_daily_clusters_7a)
# Insitu_hs_circ <- plot_compare_hs(df = SACTN_daily_clusters_7a)
# Insitu_tp_circ <- plot_compare_tp(df = SACTN_daily_clusters_7a)
# Insitu_dir_circ <- plot_compare_dir(df = SACTN_daily_clusters_7a)
# Insitu_dirw_circ <- plot_compare_dirw(df = SACTN_daily_clusters_7a)
# Insitu_spw_circ_15 <- plot_compare_spw(df = SACTN_daily_clusters_15a)
# Insitu_hs_circ_15 <- plot_compare_hs(df = SACTN_daily_clusters_15a)
# Insitu_tp_circ_15 <- plot_compare_tp(df = SACTN_daily_clusters_15a)
# Insitu_dir_circ_15 <- plot_compare_dir(df = SACTN_daily_clusters_15a)
# Insitu_dirw_circ_15 <- plot_compare_dirw(df = SACTN_daily_clusters_15a)

# ggsave(plot = Insitu_spw_circ, filename = "figures/Insitu_spw_circ.pdf")
```

Histogram: Plotting dir and dirw. This was done to determine whether or not the wave variables needed to be log transformed.

```{r}
# histogram_1 <- ggplot(data = SACTN_daily_clusters_7a, aes(x = dir_circ)) +
# geom_histogram() +
# facet_wrap(~site, scales = "free_x", ncol = 2)
# histogram_1
# 
# histogram_2 <- ggplot(data = SACTN_daily_clusters_7a, aes(x = dirw_circ)) +
# geom_histogram() +
# facet_wrap(~site, scales = "free_x", ncol = 2)
# histogram_2
# 
# histogram_3 <- ggplot(data = SACTN_daily_clusters_7a, aes(x = spw_circ)) +
# geom_histogram() +
# facet_wrap(~site, scales = "free_x", ncol = 2)
# histogram_3
```

Here i now log transform each of the Wave variables

```{r}
# SACTN_daily_clusters_7a[, 12:14] <- log(SACTN_daily_clusters_7a[12:14], 2)
# SACTN_daily_clusters_15a[, 12:14] <- log(SACTN_daily_clusters_15a[12:14], 2)
```

Temperature and wave comparison

```{r}
temp_wave_compare <- function(df){
  df1 <- df %>% 
    dplyr::mutate(year = year(date), 
                  week = week(date)) %>% 
    dplyr::select(-date) %>% 
    tidyr::gather(key = variable, value = value, 
                  -c(index:src, year, week, length:depth)) %>% 
    na.omit() %>% 
    ungroup() %>% 
    group_by(index, year, week, variable) %>% 
    na.omit() %>% 
    dplyr::summarise(value = mean(value, na.rm = T)) %>% 
    arrange(index, year, week) %>% 
    group_by(index, variable) %>% 
    mutate(index2 = 1:n())
  ggplot(data = df1, aes(x = index2)) +
    geom_line(aes(y = value, colour = variable, group = )) +
    facet_grid(variable~index, scales = "free_y")
}

temp_wave_compare(SACTN_daily_clusters_7a)
temp_wave_compare(SACTN_daily_clusters_15a)
```

Calculating the R2 value of each of the variables

```{r}
temp_wave_R2_ <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth)) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4)) %>% 
        dplyr::rename("R^2" = adj.r.squared) %>% 
    dplyr::rename(P = p.value) %>% 
    dplyr::rename(Cluster = cluster) %>% 
    dplyr::rename(Site = site) %>% 
    dplyr::rename(Variable = variable) 
  return(results)
  }

SACTN_7_R2 <- SACTN_daily_clusters_7a %>% 
 temp_wave_R2_()
SACTN_15_R2 <- SACTN_daily_clusters_15a %>% 
  temp_wave_R2_()

# These data are best represented with a table
knitr::kable(SACTN_7_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and SACTN temperature at 7m.")

# These data are best represented with a table
knitr::kable(SACTN_15_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and SACTN temperature at 15m.")

# box_scatter_7m <- ggplot(data = SACTN_7_R2, aes(x = Variable, y = "R^2")) +
#   geom_boxplot(outlier.colour = NA) +
#   geom_point(colour = "red", alpha = 0.6, position = "jitter") +
#   ggtitle("SACTN_7m") +
#   theme_bw()
# 
# box_scatter_15m <-  ggplot(data = SACTN_15_R2, aes(x = Variable, y = "R^2")) +
#   geom_boxplot(outlier.colour = NA) +
#   geom_point(colour = "red", alpha = 0.6, position = "jitter") +
#   ggtitle("SACTN_15m") +
#   theme_bw()
# 
# box_scatter <- ggarrange(box_scatter_7m, box_scatter_15m)
# box_scatter
```

# AVHRR Satellite data

Various packages in R such as ncdf4, ncdf4.helpers are useful tools for working with netCDF files. The ncdf4 package is used to read netCDF files into R. Here i load the standard packages used in R as well as the ncdf4 package to help run the data.

```{r loading_libraries, include = TRUE}
library(ncdf4) # library for processing netCDFs
#library(data.table) # for fast .csv write function, `fwrite()`
#library(tidyverse) # misc. data processing conveniences
library(reshape2) # for making a long data format
#library(plyr) # for `llply()`
library(lubridate) # for working with dates
library(stringr) # for working with strings
library(doMC); doMC::registerDoMC(cores = 4) # for multicore spead-ups
```

The next step is to open the netCDF file. This requires the pathway in which the netCDF data is stored. The function nc_open found within the ncdf4 package is used here to open the netCDF file. This function opens the file, but does not read all the data in the file into R. Instead, this function reads into memory some infomation present within this file. By running the name "nc" i am able to view all the metadata within this file. This includes the various variables present within this dataset. The next step is to create a file path which will function as an output directory. Now creating a function to read the netCDF files and convert it to csv files. In this function i am subsetting the AVHRR global dataset to only produce a csv file with data for the South African coastline.

```{r}
# nc.dir <- "/home/amieroh/Documents/spatial/test/netCDF"
# csv.dir <- "/home/amieroh/Documents/spatial/test/csv"
#          1         2
# 1234567890123456789012345
# avhrr-only-v2.19810901.nc
# specify the region as "latmin", "latmax", "lonmin", "lonmax"

# coords <- c(-39.5, -25.5, 10.5, 39.5)
# 
# ncRead <- function(nc.dir = nc.dir, csv.dir = csv.dir) {
#   nc.files <- list.files(path = nc.dir, pattern = "*.nc", full.names = TRUE, include.dirs = TRUE)
  # #nc.files <- nc.files[1:10]
  # strt.date <- str_sub(basename(nc.files[1]), start = 15, end = 22)
  # end.date <- str_sub(basename(nc.files[length(nc.files)]), start = 15, end = 22)
  # nc.init <- nc_open(nc.files[1])
  # LatIdx <- which(nc.init$dim$lat$vals > coords[1] & nc.init$dim$lat$vals < coords[2])
  # LonIdx <- which(nc.init$dim$lon$vals > coords[3] & nc.init$dim$lon$vals < coords[4])
  # nc_close(nc.init)
#   
#   # nc.file <- nc.files[1]
#   
#   ncFun <- function(nc.file = nc.files, csv.dir = csv.dir) {
#     nc <- nc_open(nc.file)
#     name.stem <- substr(basename(nc.file), 1, 13) # local
#     date.stamp <- substr(basename(nc.file), 15, 22)
#     sst <- round(ncvar_get(nc,
#                            varid = "sst",
#                            start = c(LonIdx[1], LatIdx[1], 1, 1),
#                            count = c(length(LonIdx), length(LatIdx), 1, 1)),
#                  3)
#     dimnames(sst) <- list(lon = nc$dim$lon$vals[LonIdx],
#                           lat = nc$dim$lat$vals[LatIdx])
#     nc_close(nc)
#     sst <-
#       as.data.frame(melt(sst, value.name = "temp"), row.names = NULL) %>%
#       mutate(t = ymd(date.stamp)) %>%
#       na.omit()
#     fwrite(sst,
#            file = paste0(csv.dir, name.stem, "-", strt.date, "-", end.date, ".csv"),
#            append = TRUE, col.names = FALSE)
#     rm(sst)
#   }
#   llply(nc.files, ncFun, csv.dir = csv.dir, .parallel = FALSE)
# }
# 
# ncRead(nc.dir, csv.dir)
```

I now load in the csv dataset created above.

```{r load_files1, include=TRUE}
# AVHRR_SAcoast <- read_csv("data/csvavhrr-only-v2-19810901-20180630.csv")
```

## Load subsetted AVHRR data

```{r}
# xaa <- read_csv("data/xaa.csv",  col_names = c("lon", "lat", "temp", "date"))
# xab <- read_csv("data/xab.csv",  col_names = c("lon", "lat", "temp", "date"))
# 
# # combined_OISST <- rbind(xaa, xab, xac, xad, xae, xaf)
# combined_OISST <- rbind(xaa, xab)
# rm(xaa, xab)
```

Now we create a plot which allows me to visualise the temperatures variation along the South African coastline based on the maximum and minumum dates at which temperature was collected. This is done to visualise the data.

```{r}
# Quick visualisation of the data
# combined_OISST %>% 
#   filter(date == min(date)) %>% 
#   ggplot(aes(x = lon, y = lat)) +
#   geom_raster(aes(fill = temp))
# 
# combined_OISST %>% 
#   filter(date == max(date)) %>% 
#   ggplot(aes(x = lon, y = lat)) +
#   geom_raster(aes(fill = temp))
```

## Find nearest SST pixels

Now we apply the FNN (Fast Nearest Neighbor) package to determine the nearesr SST pixel to the insitu collected sites. In some cases however our sites are located close to eachother and as such more than one sites may have the same SST record. Here we use a pixel of 1. 

```{r}
unique_pixel <- combined_OISST %>% 
#   select(lon, lat) %>% 
#   unique()
# 
# # Select 1 nearest pixel (k = 1)
# # here we ue knnx to find the closes pixel to the insitu sites
# match_index <- knnx.index(data = as.matrix(unique_pixel[,1:2]),
#                           query = as.matrix(site_list_sub[,5:6]), k = 1)
# 
# # Select SST pixels nearest to insitu sites
# pixel_match <- unique_pixel[match_index,] %>% 
#   unite(col = combi, lon, lat, sep = "/", remove = F) %>% 
#   mutate(site = site_list_sub$site)
```


```{r}
# # create a bounding box of at least 9x resol(km) from station (note this will be a rough estimate
# # due to lat/lon estimates of resol (km):
# # 9km latitude 
# 
# # finding the closes pixel to the insitu sites
# Latlon <- as.data.frame(site_list_sub[,5:6]) # Lat and longs of the insitu sites
# 
# Lat9 <- 9* (1/110.574)
# # 9km longitude 
# lon9 <- 9* (1/(111.320*cos(site_list_sub[,6]))) # R uses radians not degress
```

## Subset OISST to match in situ

I now subset the SST data to match the insitu collected seawater temperature data.

```{r}
# combined_OISST_match <- combined_OISST %>% 
#   unite(col = combi, lon, lat, sep = "/", remove = F) %>% 
#   filter(combi %in% pixel_match$combi)
# rm(combined_OISST)
```

```{r}
# # Visualise the time series
# ggplot(data = combined_OISST_match, aes(x = date, y = temp)) +
#   geom_line() +
#   facet_wrap(~combi)
# # We see below that there are only 15 pixels
# # This is because Muizenberg and Kalk Bay are very close
```

## Match up the OISST data and save
This is the dataset showing the SST data for the insitu sites at the same time and date.

```{r}
# One map view
# combined_OISST_match %>% 
#   filter(date == max(date)) %>% 
#   ggplot(aes(x = lon, y = lat)) +
#   geom_raster(aes(fill = temp))
```

```{r}
# # Duplicate the pixel for Kalk Bay and Muizenberg
# combined_OISST_sites <- combined_OISST_match %>% 
#   left_join(pixel_match, by = c("combi", "lon", "lat"))
# 
# # Check that the pixel that is shared is duplicated
# # unique(combined_OISST_sites$site)
# # Visualise time series
# ggplot(data = combined_OISST_sites, aes(x = date, y = temp)) +
#   geom_line() +
#   facet_wrap(~site)
# 
# save(combined_OISST_sites, file = "data/combined_OISST_sites.RData")
```

```{r}
load("~/Documents/HONOURSPROJECT/data/combined_OISST_sites.RData")
```

The next step is to now match the insitu temperature data with the SST data

```{r}
insitu_AVHRR<- SACTN_daily_clusters_sub_1  %>% 
  left_join(combined_OISST_sites, by = c("site", "date")) %>% 
  na.trim()
```

Plotting satellite and insitu temperature

```{r}
insitu_temp <- ggplot(data = insitu_AVHRR, aes(x = date, y = temp.x)) +
  geom_line() +
  facet_wrap(~site)

Satellite_temp <- ggplot(data = insitu_AVHRR, aes(x = date, y = temp.y)) +
  geom_line() +
  facet_wrap(~site)
```

Creating a visualisation of the insitu collected temperature data and the AVHRR temperature data

```{r}
insitu_plot <- ggplot(insitu_AVHRR, aes(x = date, y = temp.x)) +
  geom_line() +
  facet_wrap(~site, scales = "free_x", ncol = 2) +
  labs(x = "Year", y = "Null") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "#cfcfcf", size = 0.4))
# ggsave(plot = insitu_plot, filename = "figures/insitu_plot.pdf")

satellite_plot <- ggplot(insitu_AVHRR, aes(x = date, y = temp.y)) +
  geom_line() +
  facet_wrap(~site, scales = "free_x", ncol = 2) +
  labs(x = "Year", y = "Null") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "#cfcfcf", size = 0.4))
# ggsave(plot = satellite_plot, filename = "figures/satellite_plot.pdf")
```

Matching wave data with the AVHRR temperature data

```{r}
AVHRR_wave <- insitu_AVHRR %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

combine_temp_wave_7m <- function(df){
  outcome_7 <- df %>% 
  left_join(sites_complete_7a, by = c("site", "date")) %>% 
  select(-temp.x) %>% # Temp.x is the insitu collected data
  dplyr::rename(temp = temp.y) %>%
  na.trim()
  return(outcome_7)
}

combine_temp_wave_15m <- function(df){ 
  outcome_15 <- df %>% 
  left_join(sites_complete_15a, by = c("site", "date")) %>% 
  select(-temp.x) %>% # Temp.x is the insitu collected data
  dplyr::rename(temp = temp.y) %>%
  na.trim() 
  return(outcome_15)
}

AVHRR_temp_7 <- combine_temp_wave_7m(df = AVHRR_wave)
AVHRR_temp_15 <- combine_temp_wave_15m(df = AVHRR_wave)
```

# Plotting graphs
Scatter plot: Plotting dir and dirw

```{r}
# AVHRR_spw_circ <- plot_compare_spw(df = AVHRR_temp_7)
# AVHRR_hs_circ <- plot_compare_hs(df = AVHRR_temp_7)
# AVHRR_tp_circ <- plot_compare_tp(df = AVHRR_temp_7)
# AVHRR_dir_circ <- plot_compare_dir(df = AVHRR_temp_7)
# AVHRR_dirw_circ <- plot_compare_dirw(df = AVHRR_temp_7)
# AVHRR_spw_circ_15 <- plot_compare_spw(df = AVHRR_temp_7)
# AVHRR_hs_circ_15 <- plot_compare_hs(df = AVHRR_temp_7)
# AVHRR_tp_circ_15 <- plot_compare_tp(df = AVHRR_temp_7)
# AVHRR_dir_circ_15 <- plot_compare_dir(df = AVHRR_temp_7)
# AVHRR_dirw_circ_15 <- plot_compare_dirw(df = AVHRR_temp_7)
```

log transforming the Wave variables

```{r}
# AVHRR_temp_7[, 15:17] <- log(AVHRR_temp_7[15:17], 2)
# AVHRR_temp_15[, 15:17] <- log(AVHRR_temp_15[15:17], 2)
```

Calculating the R2 value of each of the variables

```{r}
temp_wave_R2_try1 <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth), -lon, -lat, -combi) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4)) %>% 
    dplyr::rename("R^2" = adj.r.squared) %>% 
    dplyr::rename(P = p.value) %>% 
    dplyr::rename(Cluster = cluster) %>% 
    dplyr::rename(Site = site) %>% 
    dplyr::rename(Variable = variable) 
  return(results)
  }

AVHRR_temp_7_R2 <- AVHRR_temp_7%>% 
  temp_wave_R2_try1()
AVHRR_temp_15_R2 <- AVHRR_temp_15 %>% 
  temp_wave_R2_try1()
# These data are best represented with a table
knitr::kable(AVHRR_temp_7_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and AVHRR temperature at 7m.")

# These data are best represented with a table
knitr::kable(AVHRR_temp_15_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and AVHRR temperature at 15m.")
``` 

# MUR satellite data

Here i load the MUR SST data

```{r}
MUR_Bordjies_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Bordjies_SST_timeseries_5nearest.csv") 
MUR_Eastern_Beach_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Eastern Beach_SST_timeseries_5nearest.csv")
MUR_Gansbaai_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Gansbaai_SST_timeseries_5nearest.csv")
MUR_Gordons_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Gordons Bay_SST_timeseries_5nearest.csv")
MUR_Hamburg_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Hamburg_SST_timeseries_5nearest.csv")
MUR_Kalk_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Kalk Bay_SST_timeseries_5nearest.csv")
MUR_Knysna_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Knysna_SST_timeseries_5nearest.csv")
MUR_Lamberts_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Lamberts Bay_SST_timeseries_5nearest.csv")
MUR_Leisure_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Leisure Bay_SST_timeseries_5nearest.csv")
MUR_Mossel_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Mossel Bay_SST_timeseries_5nearest.csv")
MUR_Muizenberg_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Muizenberg_SST_timeseries_5nearest.csv")
MUR_Orient_Beach_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Orient Beach_SST_timeseries_5nearest.csv")
MUR_Port_Edward_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Port Edward_SST_timeseries_5nearest.csv")
MUR_Saldanha_Bay_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Saldanha Bay_SST_timeseries_5nearest.csv")
MUR_Sea_Point_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Sea Point_SST_timeseries_5nearest.csv")
MUR_Stilbaai_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Stilbaai_SST_timeseries_5nearest.csv")
MUR_T_O_Strand_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_T.O. Strand_SST_timeseries_5nearest.csv")
MUR_Port_Nolloth_SST_timeseries_5nearest <- read_csv("data/MUR/MUR_Port Nolloth_SST_timeseries_5nearest.csv")

MUR_data <- rbind(MUR_Orient_Beach_SST_timeseries_5nearest, MUR_Bordjies_SST_timeseries_5nearest, MUR_Eastern_Beach_SST_timeseries_5nearest,
                  MUR_Gansbaai_SST_timeseries_5nearest, MUR_Gordons_Bay_SST_timeseries_5nearest, MUR_Hamburg_SST_timeseries_5nearest,
                  MUR_Kalk_Bay_SST_timeseries_5nearest, MUR_Knysna_SST_timeseries_5nearest, MUR_Lamberts_Bay_SST_timeseries_5nearest,
                  MUR_Leisure_Bay_SST_timeseries_5nearest, MUR_Mossel_Bay_SST_timeseries_5nearest, MUR_Muizenberg_SST_timeseries_5nearest,
                  MUR_Port_Edward_SST_timeseries_5nearest, MUR_Port_Nolloth_SST_timeseries_5nearest,
                  MUR_Saldanha_Bay_SST_timeseries_5nearest, MUR_Stilbaai_SST_timeseries_5nearest, MUR_Sea_Point_SST_timeseries_5nearest,
                  MUR_T_O_Strand_SST_timeseries_5nearest)
rm(MUR_Orient_Beach_SST_timeseries_5nearest, MUR_Bordjies_SST_timeseries_5nearest, MUR_Eastern_Beach_SST_timeseries_5nearest,
                  MUR_Gansbaai_SST_timeseries_5nearest, MUR_Gordons_Bay_SST_timeseries_5nearest, MUR_Hamburg_SST_timeseries_5nearest,
                  MUR_Kalk_Bay_SST_timeseries_5nearest, MUR_Knysna_SST_timeseries_5nearest, MUR_Lamberts_Bay_SST_timeseries_5nearest,
                  MUR_Leisure_Bay_SST_timeseries_5nearest, MUR_Mossel_Bay_SST_timeseries_5nearest, MUR_Muizenberg_SST_timeseries_5nearest,
                  MUR_Port_Edward_SST_timeseries_5nearest, MUR_Port_Nolloth_SST_timeseries_5nearest,
                  MUR_Saldanha_Bay_SST_timeseries_5nearest, MUR_Stilbaai_SST_timeseries_5nearest, MUR_Sea_Point_SST_timeseries_5nearest,
                  MUR_T_O_Strand_SST_timeseries_5nearest)

MUR_data <- MUR_data %>% 
  dplyr::rename(site = station) # Rename station name to site. This is done to match the wave data
MUR_data$date <- (ymd(MUR_data$date))
MUR_data <- MUR_data %>% 
  rename(temp = med05)
# list.file(path = "data/MUR", pattern = "csv")
```

Matching in situ sites with the MUR data sites

```{r}
match_func <- function(df){
  match <- SACTN_daily_clusters_sub_1  %>% 
  left_join(df, by = c("site", "date")) %>% 
  na.trim()
  return(match)
}

insitu_MUR <- match_func(df = MUR_data)
```

```{r}
insitu_temp <- ggplot(data = insitu_AVHRR, aes(x = date, y = temp.x)) +
  geom_line() +
  facet_wrap(~site)
insitu_temp

Satellite_temp <- ggplot(data = insitu_MUR, aes(x = date, y = temp.y)) +
  geom_line() +
  facet_wrap(~site)
Satellite_temp
```

Matching the MUR data with the wave data

```{r}
MUR_wave <- insitu_MUR %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

MUR_7 <- combine_temp_wave_7m(df = MUR_wave)
MUR_15 <- combine_temp_wave_15m(df = MUR_wave)
```

Log transform the MUR data

```{r}
# MUR_7[, 23:25] <- log(MUR_7[23:25], 2)
# MUR_15[, 23:25] <- log(MUR_15[23:25], 2)
```

Scatter plot for the MUR data

```{r}
# MUR_spw_circ <- plot_compare_spw(df = MUR_7)
# MUR_hs_circ <- plot_compare_hs(df = MUR_7)
# MUR_tp_circ <- plot_compare_tp(df = MUR_7)
# MUR_dir_circ <- plot_compare_dir(df = MUR_7)
# MUR_dirw_circ <- plot_compare_dirw(df = MUR_7)
# MUR_spw_circ_15 <- plot_compare_spw(df = MUR_15)
# MUR_hs_circ_15 <- plot_compare_hs(df = MUR_15)
# MUR_tp_circ_15 <- plot_compare_tp(df = MUR_15)
# MUR_dir_circ_15 <- plot_compare_dir(df = MUR_15)
# MUR_dirw_circ_15 <- plot_compare_dirw(df = MUR_15)
```

Calculate the R2 value

```{r}
temp_wave_R2_try1 <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth), -lat, -lon, -c(nearest1:dist2), -c(std05:std2)) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4)) %>% 
        dplyr::rename("R^2" = adj.r.squared) %>% 
    dplyr::rename(P = p.value) %>% 
    dplyr::rename(Cluster = cluster) %>% 
    dplyr::rename(Site = site) %>% 
    dplyr::rename(Variable = variable) 
  return(results)
  }

MUR_7_R2 <- MUR_7 %>% 
  temp_wave_R2_try1()
MUR_15_R2 <- MUR_15 %>% 
  temp_wave_R2_try1()

# These data are best represented with a table
knitr::kable(MUR_7_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and MUR temperature at 7m.")

# These data are best represented with a table
knitr::kable(MUR_15_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and MUR temperature at 15m.")
```

# CMC data

Here i load the CMC dataset

```{r}
CMC_Bordjies_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Bordjies_SST_timeseries_5nearest.csv")
CMC_Eastern_Beach_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Eastern Beach_SST_timeseries_5nearest.csv")
CMC_Gansbaai_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Gansbaai_SST_timeseries_5nearest.csv")
CMC_Gordons_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Gordons Bay_SST_timeseries_5nearest.csv")
CMC_Hamburg_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Hamburg_SST_timeseries_5nearest.csv")
CMC_Kalk_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Kalk Bay_SST_timeseries_5nearest.csv")
CMC_Knysna_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Knysna_SST_timeseries_5nearest.csv")
CMC_Lamberts_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Lamberts Bay_SST_timeseries_5nearest.csv")
CMC_Leisure_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Leisure Bay_SST_timeseries_5nearest.csv")
CMC_Mossel_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Mossel Bay_SST_timeseries_5nearest.csv")
CMC_Muizenberg_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Muizenberg_SST_timeseries_5nearest.csv")
CMC_Orient_Beach_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Orient Beach_SST_timeseries_5nearest.csv")
CMC_Port_Edward_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Port Edward_SST_timeseries_5nearest.csv")
CMC_Port_Nolloth_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Port Nolloth_SST_timeseries_5nearest.csv")
CMC_Saldanha_Bay_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Saldanha Bay_SST_timeseries_5nearest.csv")
CMC_Sea_Point_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Sea Point_SST_timeseries_5nearest.csv")
CMC_Stilbaai_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_Stilbaai_SST_timeseries_5nearest.csv")
CMC_T_O_Strand_SST_timeseries_5nearest <- read_csv("data/CMC/CMC_T.O. Strand_SST_timeseries_5nearest.csv")

CMC_data <- rbind(CMC_Bordjies_SST_timeseries_5nearest, CMC_Eastern_Beach_SST_timeseries_5nearest, CMC_Gansbaai_SST_timeseries_5nearest,
                  CMC_Gordons_Bay_SST_timeseries_5nearest, CMC_Hamburg_SST_timeseries_5nearest, CMC_Kalk_Bay_SST_timeseries_5nearest,
                  CMC_Knysna_SST_timeseries_5nearest,CMC_Lamberts_Bay_SST_timeseries_5nearest, CMC_Leisure_Bay_SST_timeseries_5nearest,
                  CMC_Mossel_Bay_SST_timeseries_5nearest, CMC_Muizenberg_SST_timeseries_5nearest,CMC_Orient_Beach_SST_timeseries_5nearest,
                  CMC_Port_Edward_SST_timeseries_5nearest, CMC_Port_Nolloth_SST_timeseries_5nearest,CMC_Saldanha_Bay_SST_timeseries_5nearest,
                  CMC_Stilbaai_SST_timeseries_5nearest,CMC_T_O_Strand_SST_timeseries_5nearest, CMC_Sea_Point_SST_timeseries_5nearest)
rm(CMC_Bordjies_SST_timeseries_5nearest, CMC_Eastern_Beach_SST_timeseries_5nearest, CMC_Gansbaai_SST_timeseries_5nearest,
                  CMC_Gordons_Bay_SST_timeseries_5nearest, CMC_Hamburg_SST_timeseries_5nearest, CMC_Kalk_Bay_SST_timeseries_5nearest,
                  CMC_Knysna_SST_timeseries_5nearest,CMC_Lamberts_Bay_SST_timeseries_5nearest, CMC_Leisure_Bay_SST_timeseries_5nearest,
                  CMC_Mossel_Bay_SST_timeseries_5nearest, CMC_Muizenberg_SST_timeseries_5nearest,CMC_Orient_Beach_SST_timeseries_5nearest,
                  CMC_Port_Edward_SST_timeseries_5nearest, CMC_Port_Nolloth_SST_timeseries_5nearest,CMC_Saldanha_Bay_SST_timeseries_5nearest,
                  CMC_Stilbaai_SST_timeseries_5nearest,CMC_T_O_Strand_SST_timeseries_5nearest, CMC_Sea_Point_SST_timeseries_5nearest)
CMC_data <- CMC_data %>% 
  rename(site = station)
CMC_data$date <- as.numeric(CMC_data$date)
CMC_data$date <- (ymd(CMC_data$date))

CMC_data <- CMC_data %>% 
  rename(temp = med05)
```

Matching in situ collected data with the CMC data sites

```{r}
insitu_CMC <- match_func(df = CMC_data)
```

```{r}
insitu_temp <- ggplot(data = insitu_AVHRR, aes(x = date, y = temp.x)) +
  geom_line() +
  facet_wrap(~site)
insitu_temp

Satellite_temp <- ggplot(data = insitu_CMC, aes(x = date, y = temp.y)) +
  geom_line() +
  facet_wrap(~site)
Satellite_temp
```

Matching the CMC SST data with the wave data

```{r}
CMC_wave <- insitu_CMC %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

# Combine the temperature and 7 m depth wave data

CMC_7 <- combine_temp_wave_7m(df = CMC_wave)
CMC_15 <- combine_temp_wave_15m(df = CMC_wave)
```

Log transform the CMC data

```{r}
# CMC_7[, 28:30] <- log(CMC_7[28:30], 2)
# CMC_15[, 28:30] <- log(CMC_15[28:30], 2)
```

Scatter plot for the CMC data

```{r}
# CMC_spw_circ <- plot_compare_spw(df = CMC_7)
# CMC_hs_circ <- plot_compare_hs(df = CMC_7)
# CMC_tp_circ <- plot_compare_tp(df = CMC_7)
# CMC_dir_circ <- plot_compare_dir(df = CMC_7)
# CMC_dirw_circ <- plot_compare_dirw(df = CMC_7)
# CMC_spw_circ_15 <- plot_compare_spw(df = CMC_15)
# CMC_hs_circ_15 <- plot_compare_hs(df = CMC_15)
# CMC_tp_circ_15 <- plot_compare_tp(df = CMC_15)
# CMC_dir_circ_15 <- plot_compare_dir(df = CMC_15)
# CMC_dirw_circ_15 <- plot_compare_dirw(df = CMC_15)
```

Calculate the R2 value

```{r}
# A function that runs a linear model on each metric of the combined data and get the R^2 value
temp_wave_R2_try2 <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth), -c(nearest1:climnear2), -lat, -lon, -c(std05:clim2)) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4)) %>% 
        dplyr::rename("R^2" = adj.r.squared) %>% 
    dplyr::rename(P = p.value) %>% 
    dplyr::rename(Cluster = cluster) %>% 
    dplyr::rename(Site = site) %>% 
    dplyr::rename(Variable = variable) 
  return(results)
  }

CMC_7_R2 <- CMC_7 %>% 
  temp_wave_R2_try2()
CMC_15_R2 <- CMC_7 %>% 
  temp_wave_R2_try2()

# These data are best represented with a table
knitr::kable(CMC_7_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and CMC temperature at 7m.")

# These data are best represented with a table
knitr::kable(CMC_15_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and CMC temperature at 15m.")
```

# K10 data

Here i load the K10 SST dataset

```{r}
K10_Bordjies_SST_timeseries_5nearest <- read_csv("data/K10/K10_Bordjies_SST_timeseries_5nearest.csv")
K10_Eastern_Beach_SST_timeseries_5nearest <- read_csv("data/K10/K10_Eastern Beach_SST_timeseries_5nearest.csv")
K10_Gansbaai_SST_timeseries_5nearest <- read_csv("data/K10/K10_Gansbaai_SST_timeseries_5nearest.csv")
K10_Gordons_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Gordons Bay_SST_timeseries_5nearest.csv")
K10_Hamburg_SST_timeseries_5nearest <- read_csv("data/K10/K10_Hamburg_SST_timeseries_5nearest.csv")
K10_Kalk_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Kalk Bay_SST_timeseries_5nearest.csv")
K10_Knysna_SST_timeseries_5nearest <- read_csv("data/K10/K10_Knysna_SST_timeseries_5nearest.csv")
K10_Lamberts_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Lamberts Bay_SST_timeseries_5nearest.csv")
K10_Leisure_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Leisure Bay_SST_timeseries_5nearest.csv")
K10_Mossel_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Mossel Bay_SST_timeseries_5nearest.csv")
K10_Muizenberg_SST_timeseries_5nearest <- read_csv("data/K10/K10_Muizenberg_SST_timeseries_5nearest.csv")
K10_Orient_Beach_SST_timeseries_5nearest <- read_csv("data/K10/K10_Orient Beach_SST_timeseries_5nearest.csv")
K10_Port_Edward_SST_timeseries_5nearest <- read_csv("data/K10/K10_Port Edward_SST_timeseries_5nearest.csv")
K10_Port_Nolloth_SST_timeseries_5nearest <- read_csv("data/K10/K10_Port Nolloth_SST_timeseries_5nearest.csv")
K10_Saldanha_Bay_SST_timeseries_5nearest <- read_csv("data/K10/K10_Saldanha Bay_SST_timeseries_5nearest.csv")
K10_Sea_Point_SST_timeseries_5nearest <- read_csv("data/K10/K10_Sea Point_SST_timeseries_5nearest.csv")
K10_Stilbaai_SST_timeseries_5nearest <- read_csv("data/K10/K10_Stilbaai_SST_timeseries_5nearest.csv")
K10_T_O_Strand_SST_timeseries_5nearest <- read_csv("data/K10/K10_T.O. Strand_SST_timeseries_5nearest.csv")

K10_data <- rbind(K10_Bordjies_SST_timeseries_5nearest, K10_Eastern_Beach_SST_timeseries_5nearest,K10_Gansbaai_SST_timeseries_5nearest,
                  K10_Gordons_Bay_SST_timeseries_5nearest,K10_Hamburg_SST_timeseries_5nearest,K10_Kalk_Bay_SST_timeseries_5nearest,
                  K10_Knysna_SST_timeseries_5nearest, K10_Lamberts_Bay_SST_timeseries_5nearest,K10_Leisure_Bay_SST_timeseries_5nearest,
                  K10_Mossel_Bay_SST_timeseries_5nearest,K10_Muizenberg_SST_timeseries_5nearest,K10_Orient_Beach_SST_timeseries_5nearest,
                  K10_Port_Edward_SST_timeseries_5nearest,K10_Port_Nolloth_SST_timeseries_5nearest,K10_Saldanha_Bay_SST_timeseries_5nearest,
                  K10_Stilbaai_SST_timeseries_5nearest,K10_T_O_Strand_SST_timeseries_5nearest, K10_Sea_Point_SST_timeseries_5nearest)
rm(K10_Bordjies_SST_timeseries_5nearest, K10_Eastern_Beach_SST_timeseries_5nearest,K10_Gansbaai_SST_timeseries_5nearest,
                  K10_Gordons_Bay_SST_timeseries_5nearest,K10_Hamburg_SST_timeseries_5nearest,K10_Kalk_Bay_SST_timeseries_5nearest,
                  K10_Knysna_SST_timeseries_5nearest, K10_Lamberts_Bay_SST_timeseries_5nearest,K10_Leisure_Bay_SST_timeseries_5nearest,
                  K10_Mossel_Bay_SST_timeseries_5nearest,K10_Muizenberg_SST_timeseries_5nearest,K10_Orient_Beach_SST_timeseries_5nearest,
                  K10_Port_Edward_SST_timeseries_5nearest,K10_Port_Nolloth_SST_timeseries_5nearest,K10_Saldanha_Bay_SST_timeseries_5nearest,
                  K10_Stilbaai_SST_timeseries_5nearest,K10_T_O_Strand_SST_timeseries_5nearest, K10_Sea_Point_SST_timeseries_5nearest)

K10_data <- K10_data %>% 
  rename(site = station)
K10_data$date <- as.numeric(K10_data$date)
K10_data$date <- (ymd(K10_data$date))

K10_data <- K10_data %>% 
  rename(temp = med05)
```

```{r}
insitu_K10 <- match_func(df = K10_data)
```

```{r}
insitu_temp <- ggplot(data = insitu_AVHRR, aes(x = date, y = temp.x)) +
  geom_line() +
  facet_wrap(~site)
insitu_temp

Satellite_temp <- ggplot(data = insitu_K10, aes(x = date, y = temp.y)) +
  geom_line() +
  facet_wrap(~site)
Satellite_temp
```

```{r}
K10_wave <- insitu_K10 %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

# Combine the temperature and 7 m depth wave data

K10_7 <- combine_temp_wave_7m(df = K10_wave)
K10_15 <- combine_temp_wave_15m(df = K10_wave)
```

Log transform the K10 data

```{r}
# K10_7[, 23:25] <- log(K10_7[23:25], 2)
# K10_15[, 23:25] <- log(K10_15[23:25], 2)
```

Scatter plot for the K10 data

```{r}
# K10_spw_circ <- plot_compare_spw(df = K10_7)
# K10_hs_circ <- plot_compare_hs(df = K10_7)
# K10_tp_circ <- plot_compare_tp(df = K10_7)
# K10_dir_circ <- plot_compare_dir(df = K10_7)
# K10_dirw_circ <- plot_compare_dirw(df = K10_7)
# K10_spw_circ_15 <- plot_compare_spw(df = CMC_15)
# K10_hs_circ_15 <- plot_compare_hs(df = K10_15)
# K10_tp_circ_15 <- plot_compare_tp(df = K10_15)
# K10_dir_circ_15 <- plot_compare_dir(df = K10_15)
# K10_dirw_circ_15 <- plot_compare_dirw(df = K10_15)
```

Calculate the R2 value

```{r}
# A function that runs a linear model on each metric of the combined data and get the R^2 value

K10_7_R2 <- K10_7 %>% 
  temp_wave_R2_try1()
K10_15_R2 <- K10_15 %>% 
  temp_wave_R2_try1()


# These data are best represented with a table
knitr::kable(K10_7_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and K10 temperature at 7m.")

# These data are best represented with a table
knitr::kable(K10_15_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and K10 temperature at 15m.")
```

## Wave and Wind rose diagram:
- Aim is to select the time series with the most dominant direction where wind and wave occurs using the wind and rose diagram

```{r}
library(circular)
# Need to add direction categories

# CHOOSE(1+ABS(ROUND(A1/22.5,0)),"N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW","N")

wave_daily_dir <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean.circular(circular(dir, units = "degrees")),
            dirw_circ = mean.circular(circular(dirw, units = "degrees"))) 

wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = T) %>%
  ungroup() %>% 
  left_join(wave_daily_dir)

# The wind rose diagram gives an accurate representation of how wind speed and direction is distributed at a particular location. 
# This is presented in a circular format. The length of each "spoke" around the circle is related to the frequency of time that the wind flows in a particular direction.
# Each concentric circle represents a different frequency, with zero starting at the center and increasing frequencies in the outer circles

test_PN <- wave_daily %>% 
 filter(site == "Port Nolloth")
windrose(x = test_PN$dir_circ, y = test_PN$hs_mean, main = "Port Nolloth\nWave Rose")
windrose(x = test_PN$dirw_circ, y = test_PN$spw_mean, main = "Port Nolloth\nWind Rose")

test_MB <- wave_daily %>% 
 filter(site == "Muizenberg")
windrose(x = test_MB$dir_circ, y = test_MB$hs_mean, main = "Muizenberg\nWave Rose")
windrose(x = test_MB$dirw_circ, y = test_MB$spw_mean, main = "Muizenberg\nWind Rose")

test_KB <- wave_daily %>% 
 filter(site == "Kalk Bay")
windrose(x = test_KB$dir_circ, y = test_KB$hs_mean, main = "Kalk Bay\nWave Rose")
windrose(x = test_KB$dirw_circ, y = test_KB$spw_mean, main = "Kalk Bay\nWind Rose")

test_G <- wave_daily %>% 
 filter(site == "Gansbaai")
windrose(x = test_G$dir_circ, y = test_G$hs_mean, main = "Gansbaai\nWave Rose")
windrose(x = test_G$dirw_circ, y = test_G$spw_mean, main = "Gansbaai\nWind Rose")

test_GB <- wave_daily %>% 
 filter(site == "Gordons Bay")
windrose(x = test_GB$dir_circ, y = test_GB$hs_mean, main = "Gordons Bay \nWave Rose")
windrose(x = test_GB$dirw_circ, y = test_GB$spw_mean, main = "Gordons Bay\nWind Rose")

test_LB <- wave_daily %>% 
 filter(site == "Lamberts Bay")
windrose(x = test_LB$dir_circ, y = test_LB$hs_mean, main = "Lamberts Bay\nWave Rose")
windrose(x = test_LB$dirw_circ, y = test_LB$spw_mean, main = "Lamberts Bay\nWind Rose")

test_PE <- wave_daily %>% 
 filter(site == "Port Edward")
windrose(x = test_PE$dir_circ, y = test_PE$hs_mean, main = "Port Edward\nWave Rose")
windrose(x = test_PE$dirw_circ, y = test_PE$spw_mean, main = "Port Edward\nWind Rose")

test_B <- wave_daily %>% 
 filter(site == "Bordjies")
windrose(x = test_B$dir_circ, y = test_B$hs_mean, main = "Bordjies\nWave Rose")
windrose(x = test_B$dirw_circ, y = test_B$spw_mean, main = "Bordjies\nWind Rose")
```

Calculating the mean and sd of each of the variables. Then calculating anomalies. The funs function, funs(), is used here as it provides a flexible way to generate a named list of functions for input to other functions such as the mean and sd:

```{r}
wave_daily <- wave_data %>%
  mutate(date = as.Date(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = T) %>%
  ungroup() #%>% 
  # left_join(wave_daily_dir)

# The wind rose diagram gives an accurate representation of how wind speed and direction is distributed at a particular location. 
# This is presented in a circular format. The length of each "spoke" around the circle is related to the frequency of time that the wind flows in a particular direction.
# Each concentric circle represents a different frequency, with zero starting at the center and increasing frequencies in the outer circles

#Ignore...
# test <- wave_daily %>% 
#  filter(site == "Port Nolloth")
# windrose(x = test$dir_circ, y = test$hs_mean, main = "Port Nolloth\nWave Rose")
# windrose(x = test$dirw_circ, y = test$spw_mean, main = "Port Nolloth\nWind Rose")

anom_func <- function(m){
  m1 <- m-mean(m, na.rm = T)
  return(m1)
}

suppressWarnings(wave_daily_anom <- wave_daily %>% 
  group_by(site, num, depth) %>% 
  mutate_at(vars(-c(site:date)), anom_func))
```

Calculating the annual wave dir and dirw for each of the sites excluding the year 2000:

```{r, include=TRUE}
# ?circular
wave_annually_dir <- wave_data %>%
  mutate(date = lubridate::year(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise(dir_circ = mean(circular(dir, units = "degrees")),
            dirw_circ = mean(circular(dirw, units = "degrees")))

# Calculating the mean and sd for each of the sites excluding year 2000
wave_annually <- wave_data %>%
  mutate(date = lubridate::year(date)) %>%
  group_by(site, num, depth, date) %>%
  summarise_all(funs(mean = mean, sd = sd), na.rm = TRUE) %>%
  ungroup() %>%
  left_join(wave_annually_dir) %>% 
  filter(date != 2000)

suppressWarnings(wave_annually_anom <- wave_annually %>% 
  group_by(site, num, depth) %>% 
  mutate_at(vars(-c(site:date)), anom_func))
```

### Combining waves and temperatures
Notes from meeting (June 13th, 2018)

* Y2K boundary forcing wasnt provided and takes a year to re-run so won't be used.
* Run the relationships on all of the variables against the temperature first.
* Potentially filter out only days during some large presence of some value and then see how all values relate to temperature.
    * This may then provide guidance on what to do next.
* Potentially run the MHW algorithm on the wave data variables.

Splitting the wave data into the different depths; either a depth of 7m or a depth of 15m:

```{r wave-depth-split}
sites_complete_7 <- wave_daily %>%
  filter(depth == "7m")

sites_complete_15 <- wave_daily %>%
  filter(depth == "15m")

sites_complete_7_anom <- wave_daily_anom %>%
  filter(depth == "7m")

sites_complete_15_anom <- wave_daily_anom %>%
  filter(depth == "15m")
```

Splitting the waves up into two different dataframes requires us to write a bit more code, but ultimately makes it easier to read. The function s.window controls how rapidly the seasonal component can change. Small values allow more rapid change. Setting the seasonal window to be infinite is equivalent to forcing the seasonal component to be periodic. The stlplus package for R has a plot_seasonal function that can be used to generate a cycle-subseries plot in order to visually calibrate s.window. 

```{r}
# Create site column from the index column
SACTN_daily_clusters_sub <- SACTN_daily_clusters_sub %>% 
  separate(index, into = c("site", "src"), sep = "/", remove = FALSE)

# Combine the temperature and 7 m depth wave data
SACTN_daily_clusters_7 <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_7, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 15 m depth wave data
SACTN_daily_clusters_15 <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_15, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 7 m depth wave data
SACTN_daily_clusters_7_anom <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_7_anom, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)

# Combine the temperature and 15 m depth wave data
SACTN_daily_clusters_15_anom <- SACTN_daily_clusters_sub %>% 
  left_join(sites_complete_15_anom, by = c("site", "date")) %>% 
  na.trim() %>% 
  group_by(site) %>% 
  mutate(temp_flat = stlplus(x = temp, n.p = 365, s.window = "periodic")[[1]]$remainder)
```


```{r plot-temp-wave-compare}
# Plot for creating faceted line plots looking at comparisons of trends/patterns
# Tester...
# df <- SACTN_daily_clusters_15
temp_wave_compare <- function(df){
  df1 <- df %>% 
    dplyr::mutate(year = year(date), 
                  week = week(date)) %>% 
    dplyr::select(-date) %>% 
    tidyr::gather(key = variable, value = value, 
                  -c(index:src, year, week, length:depth)) %>% 
    na.omit() %>% 
    ungroup() %>% 
    group_by(index, year, week, variable) %>% 
    na.omit() %>% 
    dplyr::summarise(value = mean(value, na.rm = T)) %>% 
    arrange(index, year, week) %>% 
    group_by(index, variable) %>% 
    mutate(index2 = 1:n())
  ggplot(data = df1, aes(x = index2)) +
    geom_line(aes(y = value, colour = variable, group = )) +
    facet_grid(variable~index, scales = "free_y")
}

temp_wave_compare(SACTN_daily_clusters_7)
temp_wave_compare(SACTN_daily_clusters_15)
```

### Comparing waves and temperatures

With our temperature and wave values paired up we now want to investigate what the relationship between these values may be. In order to do so we will use linear models, as this produces for us the coefficient of determination (R^2). We are going to use __`purrr`__ to do this as it will allow us to compare multiple variables at once: The following example uses purrr to solve a fairly realistic problem: split a data frame into pieces, fit a model to each piece, compute the summary, then extract the R2. The R2 value is a statistical measure of how close the data are to the fitted regression line. The R2 is the percentage of the response variable variation that is explained by a linear model.

```{r compare-fun}
# A function that runs a linear model on each metric of the combined data and get the R^2 value
temp_wave_R2 <- function(df){
  results <- df %>% 
    select(-index, -src, -date, -length, -c(num:depth), -temp) %>%
    gather(key = variable, 
           value = value,
           -cluster, -site, -temp_flat) %>%
    group_by(cluster, site, variable) %>%
    na.omit() %>% 
    nest() %>%
    mutate(model = purrr::map(data, ~lm(temp_flat ~ value, data = .))) %>%
    unnest(model %>% purrr::map(glance)) %>%
    select(cluster:variable, adj.r.squared, p.value) %>% 
    arrange(cluster, site) %>% 
    mutate(adj.r.squared = round(adj.r.squared, 2),
           p.value = round(p.value, 4))
  return(results)
}
```


```{r compare}
SACTN_7_R2 <- SACTN_daily_clusters_7 %>% 
  temp_wave_R2()

SACTN_15_R2 <- SACTN_daily_clusters_15 %>% 
  temp_wave_R2()

SACTN_7_R2_anom <- SACTN_daily_clusters_7_anom %>% 
  temp_wave_R2()

SACTN_15_R2_anom <- SACTN_daily_clusters_15_anom %>% 
  temp_wave_R2()
```

As we may see from these results, the R^2 values between temperatures and wave data are rather low. With R^2 = 0.07 the highest value.

#### Comparisons during only predominant wind/wave directions

Due to the rather low R^2 values found above, the follow up is to ascertain waht the potential relationship is at each site only during the prevailing wind/wave directions.
```{r compare-predom-fun}
# A function that runs a linear model on each metric of the combined data and get the R^2 value
temp_wave_predom_R2 <- function(df){
  # Find predominant wave direction
  predom_dir <- df %>% 
    mutate(dir_round = round(dir_mean, -1)) %>%
    group_by(cluster, site, dir_round) %>% 
    summarise(dir_mean_n = n()) %>% 
    na.omit() %>% 
    filter(dir_mean_n == max(dir_mean_n)) %>% 
    select(-dir_mean_n)
  # Find predominant wind direction
  predom_dirw <- df %>% 
    mutate(dirw_round = round(dirw_mean, -1)) %>%
    group_by(cluster, site, dirw_round) %>% 
    summarise(dirw_mean_n = n()) %>% 
    na.omit() %>% 
    filter(dirw_mean_n == max(dirw_mean_n))%>% 
    select(-dirw_mean_n)
  
  # Extract just those values
  ## waves
  df_dir <- df %>% 
    mutate(dir_round = round(dir_mean, -1)) %>% 
    right_join(predom_dir, by = c("site", "cluster", "dir_round")) %>%
    select(-dir_round) %>%
    temp_wave_R2() %>% 
    right_join(predom_dir, by = c("site", "cluster")) %>% 
    dplyr::rename(predom = dir_round) %>% 
    mutate(predom_var = "dir")
  ## wind
  df_dirw <- df %>% 
    mutate(dirw_round = round(dirw_mean, -1)) %>%
    right_join(predom_dirw, by = c("site", "cluster", "dirw_round")) %>%
    select(-dirw_round) %>% 
    temp_wave_R2() %>% 
    right_join(predom_dirw, by = c("site", "cluster")) %>% 
    dplyr::rename(predom = dirw_round) %>% 
    mutate(predom_var = "dirw")
  
  # Wrap it up
  results <- rbind(df_dir, df_dirw)
  return(results)
}
```

```{r compare-predom}
SACTN_7_predom_R2 <- SACTN_daily_clusters_7 %>% 
  temp_wave_predom_R2()

SACTN_15_predom_R2 <- SACTN_daily_clusters_15 %>% 
  temp_wave_predom_R2()

SACTN_7_predom_R2_anom <- SACTN_daily_clusters_7_anom %>% 
  temp_wave_predom_R2()

SACTN_15_predom_R2_predom_anom <- SACTN_daily_clusters_15_anom %>% 
  temp_wave_predom_R2()

# These data are best represented with a table
knitr::kable(SACTN_7_predom_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and SACTN temperature at 7m.")

# These data are best represented with a table
knitr::kable(SACTN_15_predom_R2, digits = 3, caption = "R^2 and p-values for the relationship between wave/wind variables and SACTN temperature at 15m.")
```











